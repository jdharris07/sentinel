<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>K2 Drag • Shelves (Simple Editor)</title>
<style>
  :root{ --ink:#e7f0ff; --muted:#aebedb; --grid:#23314a; --aspect:16/9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#060912,#0e1423);
    color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased; touch-action:manipulation;
  }
  header{
    padding:10px 12px; background:rgba(10,15,25,.9); border-bottom:1px solid #1c2740;
    position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  h1{margin:0; font-size:16px; letter-spacing:.3px; opacity:.9}
  .tabs{display:flex; gap:6px; flex-wrap:wrap}
  .tab{
    appearance:none; cursor:pointer; padding:6px 10px; border-radius:10px;
    font-size:14px; color:#aebedb; border:1px solid #2a3754; background:#0f1524;
  }
  .tab.active{ color:var(--ink); border-color:#39507e; background:#13203a; }

  .wrap{max-width:980px; margin:0 auto; padding:12px}
  .legend{font-size:14px; color:var(--muted); margin:4px 0 10px}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
  .btn{
    appearance:none; cursor:pointer; padding:6px 10px; border-radius:10px;
    font-size:14px; border:1px solid #2a3754; background:#0f1524; color:#aebedb;
  }
  .btn.primary{ border-color:#39507e; background:#13203a; color:var(--ink); }

  .field{
    position:relative; width:min(96vw, 940px); aspect-ratio:var(--aspect); margin:0 auto;
    background:#000 center/contain no-repeat; border:1px solid var(--grid); border-radius:12px;
    box-shadow: inset 0 10px 28px rgba(0,0,0,.45); overflow:visible; touch-action:none;
  }

  /* Hotspot squares */
  .hotspot{
    position:absolute; border:2px dashed transparent; background:transparent;
    border-radius:10px; z-index:2; /* above background, below meter */
    pointer-events:none; /* enabled only in edit */
  }
  .edit .hotspot{
    pointer-events:auto;
    border-color:#7ee2b8;
    background:rgba(126,226,184,.14);
  }

  /* Meter */
  .meter{ position:absolute; left:12px; top:12px; z-index:3; touch-action:none; user-select:none; -webkit-user-drag:none; cursor:grab; }
  .meter.dragging{ cursor:grabbing }
  .meter img{display:block; width:100%; height:auto; pointer-events:none}

  /* LED overlay (head region) */
  .leds{ position:absolute; left:6%; top:4%; width:88%; height:18%; pointer-events:none }
  .led{
    position:absolute; width:16%; aspect-ratio:1/1; border-radius:50%;
    opacity:.18; transform: translate(-50%,-50%);
    background: radial-gradient(circle at 50% 55%, rgba(255,255,255,.35) 0 28%, rgba(255,255,255,.05) 29% 55%, rgba(0,0,0,.15) 56% 100%);
  }
  .led.l1{ left:14%; top:50%; --col:#33d16a }
  .led.l2{ left:33%; top:42%; --col:#27c15b }
  .led.l3{ left:52%; top:36%; --col:#f1d44e }
  .led.l4{ left:71%; top:42%; --col:#ff8a3d }
  .led.l5{ left:88%; top:50%; --col:#ff4b4b }
  .led.on{
    opacity:1;
    box-shadow:0 0 6px var(--col), 0 0 18px color-mix(in srgb, var(--col) 55%, transparent);
    background:radial-gradient(circle at 50% 55%, #fff 0 18%, color-mix(in srgb, var(--col) 70%, #fff) 19% 52%, color-mix(in srgb, var(--col) 85%, #000) 53% 100%);
  }

  .status{ text-align:center; font-size:14px; color:var(--muted); margin-top:10px; min-height:22px }

  .io{margin-top:10px}
  textarea{
    width:100%; min-height:110px; border-radius:10px; border:1px solid #2a3754; background:#0f1524; color:var(--ink);
    padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
</style>
</head>
<body>
<header>
  <h1>K2 EMF Shelves</h1>
  <div class="tabs" id="shelfTabs"></div>
</header>

<div class="wrap">
  <div class="legend">Toggle Edit Mode to drag each shelf’s 4 squares. Export gives you copy-paste JSON. Squares use % so they stick on phones & desktop.</div>

  <div class="toolbar">
    <button id="editBtn" class="btn">Enter Edit Mode</button>
    <button id="exportBtn" class="btn">Export Current Shelf JSON</button>
    <span id="hint" style="color:#8fb3ff; font-size:13px;"></span>
  </div>

  <div id="field" class="field" aria-label="Shelf">
    <div id="meter" class="meter" aria-label="K2 Meter" role="img">
      <img src="K2meter.png" alt="K2 EMF meter" />
      <div class="leds">
        <span class="led l1"></span><span class="led l2"></span><span class="led l3"></span><span class="led l4"></span><span class="led l5"></span>
      </div>
    </div>
  </div>

  <div id="status" class="status"></div>
  <div class="io">
    <textarea id="ioBox" placeholder='Exported JSON for the current shelf will appear here...'></textarea>
  </div>
</div>

<script>
/* === 3 shelves × 4 squares; x/y/size in %; level 5 = all LEDs === */
const SHELVES = [
  { name:'Shelf 1', img:'shelf1.png', aspectW:702, aspectH:975,
    hotspots:[
      {x:  3, y: 18, size:20, level:5},
      {x: 27, y: 18, size:20, level:5},
      {x: 51, y: 18, size:20, level:5},
      {x: 75, y: 18, size:20, level:5}
    ]
  },
  { name:'Shelf 2', img:'shelf2.png', aspectW:724, aspectH:946,
    hotspots:[
      {x:  3, y: 44, size:20, level:5},
      {x: 27, y: 44, size:20, level:5},
      {x: 51, y: 44, size:20, level:5},
      {x: 75, y: 44, size:20, level:5}
    ]
  },
  { name:'Shelf 3', img:'shelf3.png', aspectW:700, aspectH:958,
    hotspots:[
      {x:  3, y: 70, size:20, level:5},
      {x: 27, y: 70, size:20, level:5},
      {x: 51, y: 70, size:20, level:5},
      {x: 75, y: 70, size:20, level:5}
    ]
  }
];

const field = document.getElementById('field');
const meter = document.getElementById('meter');
const statusEl = document.getElementById('status');
const leds = [...meter.querySelectorAll('.led')];
const tabsWrap = document.getElementById('shelfTabs');
const ioBox = document.getElementById('ioBox');
const editBtn = document.getElementById('editBtn');
const exportBtn = document.getElementById('exportBtn');
const hint = document.getElementById('hint');

let currentShelf=0, hotspotEls=[], editMode=false;
let draggingMeter=false, start={x:0,y:0}, offset={x:12,y:12};

/* Tabs */
SHELVES.forEach((s,i)=>{
  const b=document.createElement('button');
  b.className='tab'+(i===0?' active':'');
  b.textContent=s.name;
  b.addEventListener('click',()=>loadShelf(i));
  tabsWrap.appendChild(b);
});
function setActiveTab(i){ [...tabsWrap.children].forEach((n,idx)=>n.classList.toggle('active', idx===i)); }

/* LEDs + hit test (LED head only) */
function setLights(n){ leds.forEach((el,i)=>el.classList.toggle('on',i<n)); statusEl.textContent = n?`Level: ${n} lights`:''; }
function rect(el){ return el.getBoundingClientRect(); }
function ledHeadRect(){
  const m=rect(meter);
  const left=m.left+m.width*0.06, top=m.top+m.height*0.04;
  const width=m.width*0.88, height=m.height*0.18;
  return {left,top,right:left+width,bottom:top+height,width,height};
}
function overlapRatio(a,b){
  const x1=Math.max(a.left,b.left), y1=Math.max(a.top,b.top);
  const x2=Math.min(a.right,b.right), y2=Math.min(a.bottom,b.bottom);
  const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1);
  return (b.width*b.height)?(w*h)/(b.width*b.height):0;
}
function checkHotspots(){
  if(editMode){ setLights(0); return; } // no lighting while editing
  const head=ledHeadRect(); let best=null,bestRatio=0;
  for(const h of hotspotEls){ const r=rect(h), ratio=overlapRatio(head,r); if(ratio>bestRatio){bestRatio=ratio; best=h;} }
  if(best && bestRatio>=0.25){ setLights(+best.dataset.level||0); } else { setLights(0); }
}

/* Meter drag (disabled during edit) */
function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }
function moveMeterTo(x,y){
  const mx=meter.clientWidth*0.6, my=meter.clientHeight*0.8; // allow head to reach edges
  const minX=-mx, maxX=field.clientWidth-meter.clientWidth+mx;
  const minY=-my, maxY=field.clientHeight-meter.clientHeight+my;
  offset.x=clamp(x,minX,maxX); offset.y=clamp(y,minY,maxY);
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  checkHotspots();
}
meter.addEventListener('pointerdown',e=>{
  if(editMode) return;
  draggingMeter=true; meter.setPointerCapture(e.pointerId); meter.classList.add('dragging');
  start.x=e.clientX-offset.x; start.y=e.clientY-offset.y; e.preventDefault();
});
meter.addEventListener('pointermove',e=>{
  if(!draggingMeter) return; moveMeterTo(e.clientX-start.x, e.clientY-start.y); e.preventDefault();
});
meter.addEventListener('pointerup',()=>{ draggingMeter=false; meter.classList.remove('dragging'); });

/* Build/Clear hotspots */
function clearHotspots(){ hotspotEls.forEach(h=>h.remove()); hotspotEls=[]; }
function buildHotspots(defs){
  clearHotspots();
  defs.forEach((d,idx)=>{
    const el=document.createElement('div');
    el.className='hotspot'; el.dataset.index=idx; el.dataset.level=d.level;
    applyHotspotStyle(el, d);
    enableDrag(el, idx);
    field.appendChild(el); hotspotEls.push(el);
  });
}
function applyHotspotStyle(el, d){
  el.style.left = d.x + '%';
  el.style.top  = d.y + '%';
  el.style.width = d.size + '%';
  el.style.height= d.size + '%';
}

/* Simple click-drag in % coords (no resize) */
function enableDrag(el, idx){
  let dragging=false, sx=0, sy=0, startLeftPct=0, startTopPct=0;
  el.addEventListener('pointerdown', (e)=>{
    if(!editMode) return;
    dragging=true; el.setPointerCapture(e.pointerId);
    const s=SHELVES[currentShelf].hotspots[idx];
    startLeftPct=s.x; startTopPct=s.y; sx=e.clientX; sy=e.clientY; e.preventDefault();
  });
  el.addEventListener('pointermove', (e)=>{
    if(!editMode || !dragging) return;
    const fRect=field.getBoundingClientRect();
    const dxPct=((e.clientX - sx)/fRect.width)*100;
    const dyPct=((e.clientY - sy)/fRect.height)*100;
    const size = SHELVES[currentShelf].hotspots[idx].size;
    let newX = startLeftPct + dxPct;
    let newY = startTopPct + dyPct;
    // clamp inside field so square stays fully visible
    newX = Math.max(0, Math.min(100 - size, newX));
    newY = Math.max(0, Math.min(100 - size, newY));
    // update model + element
    const s=SHELVES[currentShelf].hotspots[idx];
    s.x = newX; s.y = newY;
    applyHotspotStyle(el, s);
    e.preventDefault();
  });
  el.addEventListener('pointerup', ()=>{ dragging=false; });
}

/* Shelf loading / responsive */
function resizeMeter(){
  const w=field.clientWidth;
  const target=Math.round(Math.min(160, Math.max(90, w*0.18)));
  meter.style.width=target+'px';
  moveMeterTo(offset.x, offset.y);
}
function setActiveTab(i){ [...tabsWrap.children].forEach((n,idx)=>n.classList.toggle('active', idx===i)); }
function loadShelf(i){
  currentShelf=i; setActiveTab(i);
  const s=SHELVES[i];
  field.style.setProperty('--aspect', `${s.aspectW}/${s.aspectH}`);
  field.style.backgroundImage = `url("${s.img}")`;
  offset={x:12,y:12};
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  resizeMeter(); setLights(0); buildHotspots(s.hotspots);
  requestAnimationFrame(checkHotspots);
}
new ResizeObserver(()=>{ resizeMeter(); checkHotspots(); }).observe(field);
loadShelf(0);

/* Edit Mode + Export */
function setEditMode(on){
  editMode = on;
  field.classList.toggle('edit', on);
  editBtn.textContent = on ? 'Exit Edit Mode' : 'Enter Edit Mode';
  hint.textContent = on ? 'Drag each square to position it. (Saved live.)' : '';
  if(!on) checkHotspots();
}
editBtn.addEventListener('click',()=> setEditMode(!editMode));

exportBtn.addEventListener('click',()=>{
  const {hotspots} = SHELVES[currentShelf];
  ioBox.value = JSON.stringify(hotspots, null, 2);
});
</script>
</body>
</html>
