<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>K2 Drag â€¢ Shelves</title>
<style>
  :root{ --ink:#e7f0ff; --muted:#aebedb; --grid:#23314a; --aspect:16/9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#060912,#0e1423);
    color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased; touch-action:manipulation;
  }
  header{
    padding:10px 12px; background:rgba(10,15,25,.9); border-bottom:1px solid #1c2740;
    position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  h1{margin:0; font-size:16px; letter-spacing:.3px; opacity:.9}
  .tabs{display:flex; gap:6px; flex-wrap:wrap}
  .tab{
    appearance:none; cursor:pointer; padding:6px 10px; border-radius:10px;
    font-size:14px; color:#aebedb; border:1px solid #2a3754; background:#0f1524;
  }
  .tab.active{ color:var(--ink); border-color:#39507e; background:#13203a; }

  .wrap{max-width:980px; margin:0 auto; padding:12px}
  .legend{font-size:14px; color:var(--muted); margin:4px 0 10px}

  .field{
    position:relative; width:min(96vw, 940px); aspect-ratio:var(--aspect); margin:0 auto;
    background:#000 center/contain no-repeat; border:1px solid var(--grid); border-radius:12px;
    box-shadow: inset 0 10px 28px rgba(0,0,0,.45); overflow:visible; touch-action:none;
  }
  .hotspot{ position:absolute; border:none; background:transparent; border-radius:10px; pointer-events:none; }

  .meter{ position:absolute; left:12px; top:12px; z-index:3; touch-action:none; user-select:none; -webkit-user-drag:none; cursor:grab; }
  .meter.dragging{ cursor:grabbing }
  .meter img{display:block; width:100%; height:auto; pointer-events:none}

  .leds{ position:absolute; left:6%; top:4%; width:88%; height:18%; pointer-events:none }
  .led{
    position:absolute; width:16%; aspect-ratio:1/1; border-radius:50%;
    opacity:.18; transform: translate(-50%,-50%);
    background: radial-gradient(circle at 50% 55%, rgba(255,255,255,.35) 0 28%, rgba(255,255,255,.05) 29% 55%, rgba(0,0,0,.15) 56% 100%);
  }
  .led.l1{ left:14%; top:50%; --col:#33d16a }
  .led.l2{ left:33%; top:42%; --col:#27c15b }
  .led.l3{ left:52%; top:36%; --col:#f1d44e }
  .led.l4{ left:71%; top:42%; --col:#ff8a3d }
  .led.l5{ left:88%; top:50%; --col:#ff4b4b }
  .led.on{
    opacity:1;
    box-shadow:0 0 6px var(--col), 0 0 18px color-mix(in srgb, var(--col) 55%, transparent);
    background:radial-gradient(circle at 50% 55%, #fff 0 18%, color-mix(in srgb, var(--col) 70%, #fff) 19% 52%, color-mix(in srgb, var(--col) 85%, #000) 53% 100%);
  }

  .status{ text-align:center; font-size:14px; color:var(--muted); margin-top:10px; min-height:22px }
</style>
</head>
<body>
<header>
  <h1>K2 EMF Shelves</h1>
  <div class="tabs" id="shelfTabs"></div>
</header>

<div class="wrap">
  <div class="legend">Drag the K2 meter around to see if anything on any of the four shelves make it light up. Make note of which things do.</div>

  <div id="field" class="field" aria-label="Shelf">
    <div id="meter" class="meter" aria-label="K2 Meter" role="img">
      <img src="K2meter.png" alt="K2 EMF meter" />
      <div class="leds">
        <span class="led l1"></span><span class="led l2"></span><span class="led l3"></span><span class="led l4"></span><span class="led l5"></span>
      </div>
    </div>
  </div>

  <div id="status" class="status"></div>
</div>

<script>
/* x/y/size are percentages; level 5 = all LEDs.
   aspectW/H must match each imageâ€™s actual pixel size for perfect alignment. */
const SHELVES = [
  {
    name:'Shelf 1', img:'shelf1.png', aspectW:702, aspectH:975,   // âœ… good
    hotspots:[
      {x:2.85,y:21.33,size:22.36,level:5},
      {x:4.27,y:37.54,size:20.09,level:5},
      {x:4.99,y:55.18,size:19.94,level:5},
      {x:27.92,y:69.64,size:20.23,level:5},
      {x:51.14,y:70.77,size:20.51,level:5},
      {x:4.27,y:70.97,size:20.09,level:5}
    ]
  },
  {
{
  name: 'Shelf 2',
  img: 'shelf2.png',
  aspectW: 724, aspectH: 946, // shelf2 image size
  hotspots: [
    { x:  2.85, y: 21.33, size: 22.36, level: 5 }, // row 1, col 1
    { x:  4.27, y: 37.54, size: 20.09, level: 5 }, // row 2, col 1
    { x:  4.99, y: 55.18, size: 19.94, level: 5 }, // row 3, col 1
    { x:  4.27, y: 70.97, size: 20.09, level: 5 }  // row 4, col 1
  ]
}

  },
  {
    name:'Shelf 3', img:'shelf3.png', aspectW:700, aspectH:958,   // âœ… good
    hotspots:[
      {x:2.71,y:7.60,size:21.71,level:5},
      {x:27.29,y:7.60,size:19.71,level:5},
      {x:52.29,y:7.60,size:21.29,level:5},
      {x:3.71,y:31.64,size:19.14,level:5},
      {x:54.86,y:37.79,size:15.86,level:5},
      {x:51.71,y:54.59,size:19.00,level:5},
      {x:3.71,y:55.11,size:19.14,level:5},
      {x:28.00,y:55.11,size:18.00,level:5},
      {x:52.71,y:71.09,size:19.57,level:5},
      {x:4.00,y:71.71,size:19.57,level:5}
    ]
  },
  {
    /* ðŸ”§ FIXED using your overlay: 10 squares (r1: c1,c2,c3; r2: c1,c2,c3; r3: c1,c2; r4: c1,c3) */
    name:'Shelf 4', img:'shelf4.png', aspectW:715, aspectH:978,
    hotspots:[
      {x: 2.97,y:19.00,size:21.68,level:5}, // r1 c1
      {x:27.06,y:19.00,size:21.68,level:5}, // r1 c2
      {x:49.84,y:19.00,size:21.68,level:5}, // r1 c3
      {x: 2.97,y:35.12,size:21.68,level:5}, // r2 c1
      {x:27.06,y:35.12,size:21.68,level:5}, // r2 c2
      {x:49.84,y:35.12,size:21.68,level:5}, // r2 c3
      {x: 2.97,y:51.41,size:21.68,level:5}, // r3 c1
      {x:27.06,y:51.41,size:21.68,level:5}, // r3 c2
      {x: 2.97,y:67.15,size:21.68,level:5}, // r4 c1
      {x:49.84,y:67.15,size:21.68,level:5}  // r4 c3
    ]
  }
];

const meter = document.getElementById('meter');
const field = document.getElementById('field');
const statusEl = document.getElementById('status');
const leds = [...meter.querySelectorAll('.led')];
const tabsWrap = document.getElementById('shelfTabs');

let currentShelf=0, hotspots=[], dragging=false, start={x:0,y:0}, offset={x:12,y:12};

/* tabs */
SHELVES.forEach((s,i)=>{
  const b=document.createElement('button');
  b.className='tab'+(i===0?' active':'');
  b.textContent=s.name;
  b.addEventListener('click',()=>loadShelf(i));
  tabsWrap.appendChild(b);
});

/* LEDs + hit test (LED head only) */
function setLights(n){ leds.forEach((el,i)=>el.classList.toggle('on',i<n)); statusEl.textContent=n?`Level: ${n} lights`:''; }
function rect(el){ return el.getBoundingClientRect(); }
function ledHeadRect(){
  const m=rect(meter);
  const left=m.left+m.width*0.06, top=m.top+m.height*0.04;
  const width=m.width*0.88, height=m.height*0.18;
  return {left,top,right:left+width,bottom:top+height,width,height};
}
function overlapRatio(a,b){
  const x1=Math.max(a.left,b.left), y1=Math.max(a.top,b.top);
  const x2=Math.min(a.right,b.right), y2=Math.min(a.bottom,b.bottom);
  const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1);
  return (b.width*b.height)?(w*h)/(b.width*b.height):0;
}
function checkHotspots(){
  const head=ledHeadRect(); let best=null,bestRatio=0;
  for(const h of hotspots){
    const r=rect(h), ratio=overlapRatio(head,r);
    if(ratio>bestRatio){bestRatio=ratio; best=h;}
  }
  if(best && bestRatio>=0.25){ setLights(+best.dataset.level||0); } else { setLights(0); }
}

/* drag â€” allow meter to hang outside frame so the LED head can line up */
function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }
function moveTo(x,y){
  const mx=meter.clientWidth*0.6, my=meter.clientHeight*0.8;
  const minX=-mx, maxX=field.clientWidth-meter.clientWidth+mx;
  const minY=-my, maxY=field.clientHeight-meter.clientHeight+my;
  offset.x=clamp(x,minX,maxX); offset.y=clamp(y,minY,maxY);
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  checkHotspots();
}
meter.addEventListener('pointerdown',e=>{
  dragging=true; meter.setPointerCapture(e.pointerId); meter.classList.add('dragging');
  start.x=e.clientX-offset.x; start.y=e.clientY-offset.y; e.preventDefault();
});
meter.addEventListener('pointermove',e=>{
  if(!dragging) return; moveTo(e.clientX-start.x, e.clientY-start.y); e.preventDefault();
});
meter.addEventListener('pointerup',()=>{ dragging=false; meter.classList.remove('dragging'); });

/* shelf management */
function clearHotspots(){ hotspots.forEach(h=>h.remove()); hotspots=[]; }
function buildHotspots(defs){
  clearHotspots();
  defs.forEach(d=>{
    const div=document.createElement('div');
    div.className='hotspot'; div.dataset.level=d.level;
    div.style.width=d.size+'%'; div.style.height=d.size+'%';
    div.style.left=d.x+'%'; div.style.top=d.y+'%';
    field.appendChild(div); hotspots.push(div);
  });
}
function setActiveTab(i){ [...tabsWrap.children].forEach((n,idx)=>n.classList.toggle('active', idx===i)); }
function resizeMeter(){
  const w=field.clientWidth;
  const target=Math.round(Math.min(140, Math.max(80, w*0.18))); // mobile-friendly
  meter.style.width=target+'px'; moveTo(offset.x, offset.y);
}
function loadShelf(i){
  currentShelf=i; setActiveTab(i);
  const s=SHELVES[i];
  field.style.setProperty('--aspect', `${s.aspectW}/${s.aspectH}`);
  field.style.backgroundImage = `url("${s.img}")`;
  offset={x:12,y:12};
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  resizeMeter(); setLights(0); buildHotspots(s.hotspots);
  requestAnimationFrame(checkHotspots);
}
new ResizeObserver(()=>{ resizeMeter(); checkHotspots(); }).observe(field);
loadShelf(0);
</script>
</body>
</html>

