<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Iron Well Witch K2</title>
<style>
  :root{ --ink:#e7f0ff; --muted:#aebedb; --grid:#23314a; --aspect:16/9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#060912,#0e1423);
    color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased; touch-action:manipulation;
  }
  header{
    padding:10px 12px; background:rgba(10,15,25,.9); border-bottom:1px solid #1c2740;
    position:sticky; top:0; z-index:5; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  h1{margin:0; font-size:16px; letter-spacing:.3px; opacity:.9}
  .tabs{display:flex; gap:6px; flex-wrap:wrap}
  .tab{
    appearance:none; cursor:pointer; padding:6px 10px; border-radius:10px;
    font-size:14px; color:#aebedb; border:1px solid #2a3754; background:#0f1524;
  }
  .tab.active{ color:var(--ink); border-color:#39507e; background:#13203a; }

  .wrap{max-width:980px; margin:0 auto; padding:12px}
  .legend{font-size:14px; color:var(--muted); margin:4px 0 10px}

  .field{
    position:relative; width:min(96vw, 940px); aspect-ratio:var(--aspect); margin:0 auto;
    background:#000 center/contain no-repeat; border:1px solid var(--grid); border-radius:12px;
    box-shadow: inset 0 10px 28px rgba(0,0,0,.45); overflow:visible; touch-action:none;
  }

  /* Hotspots (non-interactive) */
  .hotspot{
    position:absolute; border:none; background:transparent; border-radius:10px;
    pointer-events:none; z-index:2;
  }

  /* Meter */
  .meter{ position:absolute; left:12px; top:12px; z-index:3; touch-action:none; user-select:none; -webkit-user-drag:none; cursor:grab; }
  .meter.dragging{ cursor:grabbing }
  .meter img{display:block; width:100%; height:auto; pointer-events:none}

  /* LED overlay (head region) */
  .leds{ position:absolute; left:6%; top:4%; width:88%; height:18%; pointer-events:none }
  .led{
    position:absolute; width:16%; aspect-ratio:1/1; border-radius:50%;
    opacity:.18; transform: translate(-50%,-50%);
    background: radial-gradient(circle at 50% 55%, rgba(255,255,255,.35) 0 28%, rgba(255,255,255,.05) 29% 55%, rgba(0,0,0,.15) 56% 100%);
  }
  .led.l1{ left:14%; top:50%; --col:#33d16a }
  .led.l2{ left:33%; top:42%; --col:#27c15b }
  .led.l3{ left:52%; top:36%; --col:#f1d44e }
  .led.l4{ left:71%; top:42%; --col:#ff8a3d }
  .led.l5{ left:88%; top:50%; --col:#ff4b4b }
  .led.on{
    opacity:1;
    box-shadow:0 0 6px var(--col), 0 0 18px color-mix(in srgb, var(--col) 55%, transparent);
    background:radial-gradient(circle at 50% 55%, #fff 0 18%, color-mix(in srgb, var(--col) 70%, #fff) 19% 52%, color-mix(in srgb, var(--col) 85%, #000) 53% 100%);
  }

  .status{ text-align:center; font-size:14px; color:var(--muted); margin-top:10px; min-height:22px }
</style>
</head>
<body>
<header>
  <h1>K2 EMF Shelves</h1>
  <div class="tabs" id="shelfTabs"></div>
</header>

<div class="wrap">
  <div class="legend">Drag the K2 meter around each shelf image. Watch for Electromagnetic Hot Spots.</div>

  <div id="field" class="field" aria-label="Shelf">
    <div id="meter" class="meter" aria-label="K2 Meter" role="img">
      <img src="K2meter.png" alt="K2 EMF meter" />
      <div class="leds">
        <span class="led l1"></span><span class="led l2"></span><span class="led l3"></span><span class="led l4"></span><span class="led l5"></span>
      </div>
    </div>
  </div>

  <div id="status" class="status"></div>
</div>

<script>
/* ===== VISUAL TWEAK =====
   HOTSPOT_SHAPE: 1.00 = true square; <1 = slightly shorter (less tall).
   Keeps visuals consistent across mobile/desktop.
*/
const HOTSPOT_SHAPE = 0.88;

/* ===== YOUR BAKED SHELVES (from your JSON) ===== */
const SHELVES = [
  {
    name: "Shelf 1",
    img: "shelf1.png",
    aspectW: 702,
    aspectH: 975,
    hotspots: [
      { x: 76.4751859624335, y: 23.19942786351181, size: 20, level: 5 },
      { x: 3.808509015022441, y: 23.134190519770357, size: 20, level: 5 },
      { x: 28.304960210272608, y: 39.082792051354, size: 20, level: 5 },
      { x: 51.950358938663555, y: 70.85140288363331, size: 20, level: 5 }
    ]
  },
  {
    name: "Shelf 2",
    img: "shelf2.png",
    aspectW: 724,
    aspectH: 946,
    hotspots: [
      { x: 6.333334415516955, y: 22.93987161554154, size: 20, level: 5 },
      { x: 27.92198797997008, y: 38.51785213445026, size: 20, level: 5 },
      { x: 5.397160956200139, y: 54.25867243099395, size: 20, level: 5 },
      { x: 51.453896380485375, y: 70.32516482876474, size: 20, level: 5 }
    ]
  },
  {
    name: "Shelf 3",
    img: "shelf3.png",
    aspectW: 700,
    aspectH: 958,
    hotspots: [
      { x: 51.86524606258311, y: 22.997191652539218, size: 20, level: 5 },
      { x: 28.205671594498007, y: 39.37303092579248, size: 20, level: 5 },
      { x: 28.304966703374333, y: 70.88098190060104, size: 20, level: 5 },
      { x: 76.13474744431515, y: 71.14008934029265, size: 20, level: 5 }
    ]
  }
];

/* ===== DOM & STATE ===== */
const field = document.getElementById('field');
const meter = document.getElementById('meter');
const statusEl = document.getElementById('status');
const leds = [...meter.querySelectorAll('.led')];
const tabsWrap = document.getElementById('shelfTabs');

let currentShelf = 0;
let hotspotEls = [];
let draggingMeter=false, start={x:0,y:0}, offset={x:12,y:12};

/* ===== Tabs ===== */
SHELVES.forEach((s,i)=>{
  const b=document.createElement('button');
  b.className='tab'+(i===0?' active':'');
  b.textContent=s.name;
  b.type='button';
  b.addEventListener('click',()=>loadShelf(i));
  tabsWrap.appendChild(b);
});
function setActiveTab(i){ [...tabsWrap.children].forEach((n,idx)=>n.classList.toggle('active', idx===i)); }

/* ===== LEDs + hit test (LED head only) ===== */
function setLights(n){ leds.forEach((el,i)=>el.classList.toggle('on',i<n));
  statusEl.textContent = n ? `Level: ${n} lights` : ''; }
function rect(el){ return el.getBoundingClientRect(); }
function ledHeadRect(){
  const m=rect(meter);
  const left=m.left+m.width*0.06, top=m.top+m.height*0.04;
  const width=m.width*0.88, height=m.height*0.18;
  return {left,top,right:left+width,bottom:top+height,width,height};
}
function overlapRatio(a,b){
  const x1=Math.max(a.left,b.left), y1=Math.max(a.top,b.top);
  const x2=Math.min(a.right,b.right), y2=Math.min(a.bottom,b.bottom);
  const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1);
  return (b.width*b.height)?(w*h)/(b.width*b.height):0;
}
function checkHotspots(){
  const head=ledHeadRect(); let best=null,bestRatio=0;
  for(const h of hotspotEls){ const r=rect(h), ratio=overlapRatio(head,r); if(ratio>bestRatio){bestRatio=ratio; best=h;} }
  if(best && bestRatio>=0.25){ setLights(+best.dataset.level||0); } else { setLights(0); }
}

/* ===== Meter drag ===== */
function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }
function moveMeterTo(x,y){
  const mx=meter.clientWidth*0.6, my=meter.clientHeight*0.8; // let head reach edges
  const minX=-mx, maxX=field.clientWidth-meter.clientWidth+mx;
  const minY=-my, maxY=field.clientHeight-meter.clientHeight+my;
  offset.x=clamp(x,minX,maxX); offset.y=clamp(y,minY,maxY);
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  checkHotspots();
}
meter.addEventListener('pointerdown',e=>{
  draggingMeter=true; meter.setPointerCapture(e.pointerId); meter.classList.add('dragging');
  start.x=e.clientX-offset.x; start.y=e.clientY-offset.y; e.preventDefault();
});
meter.addEventListener('pointermove',e=>{
  if(!draggingMeter) return; moveMeterTo(e.clientX-start.x, e.clientY-start.y); e.preventDefault();
});
meter.addEventListener('pointerup',()=>{ draggingMeter=false; meter.classList.remove('dragging'); });

/* ===== Hotspots ===== */
function clearHotspots(){ hotspotEls.forEach(h=>h.remove()); hotspotEls=[]; }

/* height% computed so boxes are slightly shorter than squares, stable to shelf aspect */
function computeHeightPct(widthPct, aspectW, aspectH){
  return widthPct * (aspectW / aspectH) * HOTSPOT_SHAPE;
}
function applyHotspotStyle(el, d, shelf){
  const hPct = computeHeightPct(d.size, shelf.aspectW, shelf.aspectH);
  el.style.left   = d.x + '%';
  el.style.top    = d.y + '%';
  el.style.width  = d.size + '%';
  el.style.height = hPct + '%';
}
function buildHotspots(defs){
  clearHotspots();
  const shelf = SHELVES[currentShelf];
  defs.forEach(d=>{
    const el=document.createElement('div');
    el.className='hotspot'; el.dataset.level=d.level;
    applyHotspotStyle(el, d, shelf);
    field.appendChild(el); hotspotEls.push(el);
  });
}

/* ===== Shelf loading / responsive ===== */
function resizeMeter(){
  const w=field.clientWidth;
  const target=Math.round(Math.min(160, Math.max(90, w*0.18)));
  meter.style.width=target+'px';
  moveMeterTo(offset.x, offset.y);
}
function loadShelf(i){
  currentShelf=i; setActiveTab(i);
  const s=SHELVES[i];
  field.style.setProperty('--aspect', `${s.aspectW}/${s.aspectH}`);
  field.style.backgroundImage = `url("${s.img}")`;
  offset={x:12,y:12};
  meter.style.left=offset.x+'px'; meter.style.top=offset.y+'px';
  resizeMeter(); setLights(0); buildHotspots(s.hotspots);
  requestAnimationFrame(checkHotspots);
}
new ResizeObserver(()=>{ resizeMeter(); checkHotspots(); }).observe(field);
loadShelf(0);
</script>
</body>
</html>

