<!DOCTYPE html>
<html>
<head>
<title>Hexad Lead Gen</title>

<style>
:root {
  --green: #6bb841;
  --dark: #0f172a;
  --card: #111827;
  --text: #e5e7eb;
  --red: #7f1d1d;
}

body {
  font-family: system-ui;
  background: var(--dark);
  color: var(--text);
  margin: 0;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 30px;
}

h1 {
  color: var(--green);
}

.card {
  background: var(--card);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 0 20px rgba(0,0,0,.4);
}

input, select, textarea {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  background: #020617;
  border: 1px solid #1f2937;
  color: white;
  border-radius: 6px;
}

select.not-interested {
  background: var(--red);
  border-color: #ef4444;
}

button {
  background: var(--green);
  border: none;
  padding: 10px 16px;
  color: black;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  filter: brightness(1.1);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  background: #020617;
  color: var(--green);
  padding: 8px;
}

td {
  padding: 6px;
  border-bottom: 1px solid #1f2937;
}

tr:hover {
  background: #020617;
}

.edit-btn {
  background: #1f2937;
  color: var(--green);
  padding: 4px 8px;
  font-size: 12px;
}
</style>
</head>
<body>

<div class="container">

<h1>Hexad Lead Gen</h1>

<div class="card">
<h3>Add / Edit Lead</h3>

<input id="row" type="hidden">
<input id="user" placeholder="Your Name">

<select id="company">
<option value="" disabled selected>Select Company</option>
</select>

<input id="name" placeholder="Contact Name">
<input id="phone" placeholder="Phone">
<input id="email" placeholder="Email">

<select id="method">
<option value="" disabled selected>Select Contact Method</option>
<option>Phone</option>
<option>Email</option>
<option>LinkedIn</option>
<option>In Person</option>
</select>

<select id="status">
<option value="" disabled selected>Select Status</option>
<option>No Reply</option>
<option>Not Interested</option>
<option>Interested</option>
<option>Meeting Set</option>
</select>

<textarea id="notes" placeholder="Notes"></textarea>

<button onclick="saveLead()">Save</button>
<p id="msg"></p>
</div>

<div class="card">
<input id="search" placeholder="Search name, company, phone, email" onkeyup="filterTable()">

<table>
<thead>
<tr>
<th>Edit</th>
<th>Date</th>
<th>User</th>
<th>Company</th>
<th>Name</th>
<th>Phone</th>
<th>Email</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyxEovCInWkO8vqhg_hgcqK9bq3l-e7ek_lwmQ79by6mFmOBwLKob_jJLhKOxm_0jmkNA/exec";

let allData = [];

// ---------- LOAD COMPANIES ----------
async function loadCompanies() {
  try {
    const res = await fetch(API + "?action=getCompanies");
    const companies = await res.json();

    const companySelect = document.getElementById("company");
    companySelect.innerHTML = `<option value="" disabled selected>Select Company</option>`;

    companies.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      companySelect.appendChild(opt);
    });

  } catch (err) {
    console.error("Company load error:", err);
  }
}

// ---------- LOAD LEADS ----------
async function loadLeads() {
  const res = await fetch(API + "?action=getLeads");
  allData = await res.json();
  renderTable(allData);
}

// ---------- RENDER TABLE ----------
function renderTable(data) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(r => {
    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td><button class="edit-btn" onclick='editRow(${JSON.stringify(r)})'>Edit</button></td>
      <td>${r[1] ? new Date(r[1]).toLocaleString() : ""}</td>
      <td>${r[2] || ""}</td>
      <td>${r[3] || ""}</td>
      <td>${r[4] || ""}</td>
      <td>${r[5] || ""}</td>
      <td>${r[6] || ""}</td>
      <td>${r[8] || ""}</td>
    `;

    tbody.appendChild(tr);
  });
}

// ---------- SEARCH ----------
function filterTable() {
  const term = document.getElementById("search").value.toLowerCase();
  const filtered = allData.filter(r => r.join(" ").toLowerCase().includes(term));
  renderTable(filtered);
}

// ---------- EDIT ----------
function editRow(r) {
  document.getElementById("row").value = r[0];
  document.getElementById("user").value = r[2];
  document.getElementById("company").value = r[3];
  document.getElementById("name").value = r[4];
  document.getElementById("phone").value = r[5];
  document.getElementById("email").value = r[6];
  document.getElementById("method").value = r[7] || "";
  document.getElementById("status").value = r[8] || "";
  document.getElementById("notes").value = r[9] || "";

  statusColor();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ---------- STATUS COLOR ----------
function statusColor() {
  const status = document.getElementById("status");
  status.classList.remove("not-interested");

  if (status.value === "Not Interested") {
    status.classList.add("not-interested");
  }
}

document.getElementById("status").addEventListener("change", statusColor);

// ---------- DUPLICATE CHECK ----------
function isDuplicate(phoneVal, emailVal, currentRow) {
  return allData.some(r => {
    if (currentRow && r[0] == currentRow) return false;
    return (
      (emailVal && r[6] === emailVal) ||
      (phoneVal && r[5] === phoneVal)
    );
  });
}

// ---------- SAVE ----------
async function saveLead() {
  const data = {
    row: document.getElementById("row").value,
    user: document.getElementById("user").value.trim(),
    company: document.getElementById("company").value,
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
    method: document.getElementById("method").value,
    status: document.getElementById("status").value,
    notes: document.getElementById("notes").value.trim()
  };

  if (!data.company) {
    msg.innerText = "Select a company";
    return;
  }

  if (!data.name) {
    msg.innerText = "Contact name required";
    return;
  }

  if (!data.status) {
    msg.innerText = "Select a status";
    return;
  }

  if (isDuplicate(data.phone, data.email, data.row)) {
    msg.innerText = "Duplicate found (same phone or email)";
    msg.style.color = "red";
    return;
  }

  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify(data)
  });

  const result = await res.json();
  msg.innerText = result.result;
  msg.style.color = "#6bb841";

  // Reset
  document.getElementById("row").value = "";
  document.getElementById("user").value = "";
  document.getElementById("name").value = "";
  document.getElementById("phone").value = "";
  document.getElementById("email").value = "";
  document.getElementById("notes").value = "";
  document.getElementById("method").selectedIndex = 0;
  document.getElementById("status").selectedIndex = 0;
  document.getElementById("company").selectedIndex = 0;

  loadLeads();
}

// ---------- INIT ----------
loadCompanies();
loadLeads();
</script>

</body>
</html>
