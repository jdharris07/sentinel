<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GreenLead</title>
<style>
:root{
  --brand:#6dc84d;
  --bg:#0f172a;
  --panel:#1e293b;
  --panel2:#111827;
  --border:#334155;
  --text:#e2e8f0;
}
*{ box-sizing:border-box; }
body{ font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); margin:0; }

/* Header */
.header{ display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 22px; background: var(--panel2); border-bottom:1px solid var(--border); }
.header-left{ display:flex; align-items:center; gap:14px; }
.logo{ height:120px; width:auto; object-fit:contain; filter: drop-shadow(0 0 8px rgba(109,200,77,.35)); }
.brand{ display:flex; flex-direction:column; line-height:1.1; }
.brand .title{ font-size:20px; font-weight:700; letter-spacing:.3px; }
.brand .subtitle{ font-size:12px; color:#9ca3af; }
.header-right{ display:flex; align-items:center; gap:10px; }
.user-pill{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:999px; background:#0b1220; color:#cbd5e1; font-size:13px; }
.user-dot{ width:8px;height:8px;border-radius:999px;background:var(--brand); box-shadow: 0 0 0 3px rgba(109,200,77,.15); }
.btn{ border:1px solid var(--border); background:#0b1220; color:var(--brand); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
.btn:hover{ border-color: rgba(109,200,77,.7); }

/* Layout */
.container{ max-width:1400px; margin:0 auto; padding:22px; }

/* Controls */
.controls{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
.search-box{ width:min(520px, 100%); padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: var(--panel); color:white; outline:none; }
.search-box:focus{ border-color: rgba(109,200,77,.7); box-shadow: 0 0 0 3px rgba(109,200,77,.15); }

/* Form */
.collapsible{ background: var(--brand); color:#0b1220; cursor:pointer; padding:10px 14px; border:none; font-weight:800; font-size:14px; border-radius:10px; }
.collapsible:hover{ filter:brightness(1.05); }
.content{ display:none; background: var(--panel); border:1px solid var(--border); padding:14px; border-radius:12px; margin: 10px 0 18px 0; }
.form-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px; }
@media (max-width:1100px){ .form-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (max-width:700px){ .form-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
input, select, textarea{ padding:10px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:white; outline:none; width:100%; }
input:focus, select:focus, textarea:focus{ border-color: rgba(109,200,77,.7); box-shadow: 0 0 0 3px rgba(109,200,77,.15); }
textarea{ grid-column: 1 / -1; resize: vertical; min-height: 90px; }
button.save{ background: var(--brand); color:#0b1220; padding:10px 14px; border-radius:10px; cursor:pointer; border:none; font-weight:900; width:fit-content; }
button.save:hover{ filter:brightness(1.05); }
.small-help{ grid-column: 1 / -1; color:#94a3b8; font-size:12px; margin-top:-6px; }

/* Table */
.table-wrap{ background: var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
table{ width:100%; border-collapse: collapse; }
th{ background: var(--panel2); color: var(--brand); text-align:left; padding:10px; font-size:13px; border-bottom:1px solid var(--border); position: sticky; top: 0; z-index: 1; }
td{ padding:9px 10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align: top; }
tr:hover{ background:#0b1220; }
td.actions button{ background:#0b1220; border:1px solid var(--border); color: var(--brand); padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:800; }
td.actions button:hover{ border-color: rgba(109,200,77,.7); }

/* Status */
.status-red{ background:#7f1d1d; color:#fff; padding:3px 8px; border-radius:999px; display:inline-block; font-size:12px; line-height:1.6; }

/* Notes link */
.note-cell{ cursor:pointer; color: var(--brand); text-decoration: underline; text-underline-offset: 2px; }

/* Modal */
.modal{ display:none; position:fixed; z-index:10; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.75); }
.modal-content{ background: var(--panel); margin: 8% auto; padding:18px; width:min(560px, 92vw); border-radius:12px; border:1px solid var(--border); }
.modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.modal-title{ margin:0; color: var(--brand); font-size:16px; font-weight:900; }
.close{ cursor:pointer; color: var(--brand); font-size:18px; font-weight:900; background: transparent; border:none; }

/* Login */
.login-card{ background: var(--panel); margin: 10% auto; padding:18px; width:min(420px, 92vw); border-radius:12px; border:1px solid var(--border); }
.login-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
.err{ color:#fca5a5; font-size:13px; margin-top:6px; min-height:18px; }
</style>
</head>

<body>

<div class="header">
  <div class="header-left">
    <img src="GreenLeadLogo.png" class="logo" alt="GreenLead Logo">
    <div class="brand">
      <div class="title">GreenLead</div>
      <div class="subtitle">Shared lead tracking</div>
    </div>
  </div>
  <div class="header-right">
    <div class="user-pill" id="userPill" style="display:none;">
      <span class="user-dot"></span>
      <span id="userNameLabel"></span>
    </div>
    <button class="btn" id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">

  <div class="controls">
    <input class="search-box" id="search" placeholder="Search name, company, phone or email..." onkeyup="loadLeads()">
    <button class="collapsible" onclick="toggleForm()">+ Add Lead</button>
  </div>

  <div class="content" id="formSection">
    <div class="form-grid">
      <select id="company"></select>

      <input id="name" placeholder="Contact Name">
      <input id="phone" placeholder="Phone (xxx-xxx-xxxx)" inputmode="numeric" maxlength="12">
      <input id="email" placeholder="Email">

      <select id="method">
        <option value="">Contact Method</option>
        <option>Phone</option><option>Email</option><option>LinkedIn</option><option>In Person</option>
      </select>

      <select id="status">
        <option value="">Status</option>
        <option>No Reply</option><option>Interested</option><option>Meeting Set</option><option>Not Interested</option>
      </select>

      <textarea id="notes" placeholder="Add Note (this appends to the record with today’s date)" rows="3"></textarea>
      <div class="small-help" id="existingNotesHint" style="display:none;"></div>

      <button class="save" onclick="saveLead()">Save Lead</button>
    </div>
  </div>

  <div class="table-wrap">
    <table id="leadsTable">
      <thead>
        <tr>
          <th style="width:110px;">Date</th>
          <th style="width:120px;">User</th>
          <th style="width:180px;">Company</th>
          <th style="width:140px;">Name</th>
          <th style="width:130px;">Phone</th>
          <th style="width:190px;">Email</th>
          <th style="width:120px;">Method</th>
          <th style="width:140px;">Status</th>
          <th style="width:120px;">Notes</th>
          <th style="width:90px;">Edit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Notes Modal -->
<div id="noteModal" class="modal" onclick="if(event.target.id==='noteModal') closeModal();">
  <div class="modal-content">
    <div class="modal-head">
      <h3 class="modal-title">Notes</h3>
      <button class="close" onclick="closeModal()">✕</button>
    </div>
    <div id="modalText" style="white-space:pre-wrap; line-height:1.5;"></div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="login-card">
    <div class="modal-head">
      <h3 class="modal-title">Login</h3>
      <span></span>
    </div>

    <input id="loginUsername" placeholder="Username" autocomplete="username">
    <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password">
    <div class="err" id="loginError"></div>

    <div class="login-actions">
      <button class="btn" onclick="attemptLogin()">Login</button>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwzavtLoTGp8NdtZTxu6lX5dybHgS0Fby5VmdYJFAFZqDi1Bep98hz_3yW37-0Tptl0nw/exec";
let editRow = null;
let cachedCompanies = [];
let currentRowNotes = "";
let notesClickWired = false;

function getToken(){ return localStorage.getItem("greenlead_token") || ""; }
function getDisplayName(){ return localStorage.getItem("greenlead_displayName") || ""; }

function setSession(token, displayName){
  localStorage.setItem("greenlead_token", token);
  localStorage.setItem("greenlead_displayName", displayName);
  renderSessionUI();
}
function clearSession(){
  localStorage.removeItem("greenlead_token");
  localStorage.removeItem("greenlead_displayName");
  renderSessionUI();
}
function renderSessionUI(){
  const token = getToken();
  const displayName = getDisplayName();
  const pill = document.getElementById("userPill");
  const logoutBtn = document.getElementById("logoutBtn");
  const nameLabel = document.getElementById("userNameLabel");

  if(token && displayName){
    pill.style.display = "flex";
    logoutBtn.style.display = "inline-block";
    nameLabel.textContent = displayName;
  }else{
    pill.style.display = "none";
    logoutBtn.style.display = "none";
    nameLabel.textContent = "";
  }
}

function showLogin(){
  document.getElementById("loginError").textContent = "";
  document.getElementById("loginPassword").value = "";
  document.getElementById("loginModal").style.display = "block";
  setTimeout(()=>document.getElementById("loginUsername").focus(), 50);
}
function hideLogin(){ document.getElementById("loginModal").style.display = "none"; }

function logout(){
  clearSession();
  showLogin();
}

document.addEventListener("keydown", (e)=>{
  if(document.getElementById("loginModal").style.display === "block" && e.key === "Enter"){
    attemptLogin();
  }
});

window.onload = function(){
  renderSessionUI();
  if(!getToken()) showLogin();
  wirePhoneMask();
  loadCompanies();
  loadLeads();
};

function toggleForm(){
  const section = document.getElementById("formSection");
  section.style.display = section.style.display==="block" ? "none" : "block";
}

/* ===== Phone auto format: xxx-xxx-xxxx ===== */
function wirePhoneMask(){
  const phoneEl = document.getElementById("phone");
  phoneEl.addEventListener("input", () => {
    const digits = phoneEl.value.replace(/\D/g, "").slice(0, 10);
    let out = digits;
    if (digits.length > 3 && digits.length <= 6) out = digits.slice(0,3) + "-" + digits.slice(3);
    else if (digits.length > 6) out = digits.slice(0,3) + "-" + digits.slice(3,6) + "-" + digits.slice(6);
    phoneEl.value = out;
  });
}

/* ===== Login ===== */
async function attemptLogin(){
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value;

  if(!u || !p){
    document.getElementById("loginError").textContent = "Enter username and password.";
    return;
  }

  try{
    const res = await fetch(scriptURL, {
      method:"POST",
      body: JSON.stringify({ action:"login", username:u, password:p })
    });
    const data = await res.json();

    if(data.ok){
      setSession(data.token, data.displayName);
      hideLogin();
    }else{
      document.getElementById("loginError").textContent = data.error || "Login failed.";
    }
  }catch(err){
    console.error("Login failed:", err);
    document.getElementById("loginError").textContent = "Network blocked or login failed.";
  }
}

/* ===== Companies ===== */
function normalizeCompany(s){
  return (s || "").trim().replace(/\s+/g," ").toLowerCase();
}

async function loadCompanies(){
  try{
    const res = await fetch(scriptURL + "?action=getCompanies");
    const companies = await res.json();
    cachedCompanies = Array.isArray(companies) ? companies : [];
    renderCompanyDropdown();
  }catch(err){
    console.error("Failed to load companies:", err);
  }
}

function renderCompanyDropdown(){
  const select = document.getElementById("company");

  const opts = [
    `<option value="__add__">➕ Add company...</option>`,
    `<option value="">Select Company</option>`,
    ...cachedCompanies.map(c => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`)
  ];

  select.innerHTML = opts.join("");

  select.onchange = async () => {
    if (select.value === "__add__") {
      await promptAddCompany();
    }
  };
}

async function promptAddCompany(){
  const token = getToken();
  if(!token){ showLogin(); return; }

  let name = prompt("Enter the new company name:");
  if(!name){
    document.getElementById("company").value = "";
    return;
  }

  name = name.trim().replace(/\s+/g," ");
  const norm = normalizeCompany(name);

  const existing = cachedCompanies.find(c => normalizeCompany(c) === norm);
  if(existing){
    alert("That company already exists. Selecting existing entry.");
    document.getElementById("company").value = existing;
    return;
  }

  try{
    const res = await fetch(scriptURL, {
      method:"POST",
      body: JSON.stringify({ action:"addCompany", token, company: name })
    });
    const out = await res.json();

    if(out.error){
      alert(out.error);
      document.getElementById("company").value = "";
      return;
    }

    await loadCompanies();
    document.getElementById("company").value = out.company;

    if(out.added) alert("Company added.");
    else alert("Company already existed. Selected existing entry.");

  }catch(err){
    console.error("Add company failed:", err);
    alert("Could not add company (network or server error).");
    document.getElementById("company").value = "";
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function escapeHtmlAttr(s){ return escapeHtml(s); }

/* ===== Notes safe encoding (Base64 UTF-8) ===== */
function toB64Utf8(str){
  // UTF-8 -> base64
  return btoa(unescape(encodeURIComponent(str)));
}
function fromB64Utf8(b64){
  // base64 -> UTF-8
  return decodeURIComponent(escape(atob(b64)));
}

function wireNotesClicks(){
  if(notesClickWired) return;
  notesClickWired = true;

  // Delegate clicks for any element with [data-notes-b64]
  document.addEventListener("click", (e) => {
    const el = e.target.closest("[data-notes-b64]");
    if(!el) return;
    const b64 = el.getAttribute("data-notes-b64") || "";
    try{
      const text = b64 ? fromB64Utf8(b64) : "";
      showNotes(text);
    }catch(err){
      console.error("Failed to decode notes:", err);
      showNotes("No notes");
    }
  });
}

/* ===== Leads ===== */
async function loadLeads(){
  wireNotesClicks();

  try{
    const res = await fetch(scriptURL + "?action=getLeads");
    const data = await res.json();

    const search = document.getElementById("search").value.toLowerCase();
    const tbody = document.querySelector("#leadsTable tbody");
    tbody.innerHTML = "";

    data.forEach(row=>{
      const text = row.join(" ").toLowerCase();
      if(!text.includes(search)) return;

      const statusCell = row[8] === "Not Interested"
        ? `<span class="status-red">${escapeHtml(row[8])}</span>`
        : escapeHtml(row[8] || "");

      const notesRaw = String(row[9] || "");
      const hasNotes = notesRaw.trim().length > 0;

      // ✅ No inline JS. Just data attribute.
      const notesLink = hasNotes
        ? `<span class="note-cell" data-notes-b64="${toB64Utf8(notesRaw)}">View Note</span>`
        : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row[1] ? new Date(row[1]).toLocaleDateString() : ""}</td>
        <td>${escapeHtml(row[2]||"")}</td>
        <td>${escapeHtml(row[3]||"")}</td>
        <td>${escapeHtml(row[4]||"")}</td>
        <td>${escapeHtml(row[5]||"")}</td>
        <td>${escapeHtml(row[6]||"")}</td>
        <td>${escapeHtml(row[7]||"")}</td>
        <td>${statusCell}</td>
        <td>${notesLink}</td>
        <td class="actions"><button onclick='editLead(${JSON.stringify(row)})'>Edit</button></td>
      `;
      tbody.appendChild(tr);
    });

  }catch(err){
    console.error("Failed to load leads:", err);
  }
}

function showNotes(text){
  document.getElementById("modalText").innerText = text || "No notes";
  document.getElementById("noteModal").style.display = "block";
}

function closeModal(){
  document.getElementById("noteModal").style.display = "none";
}

function editLead(row){
  editRow = row[0];
  currentRowNotes = String(row[9] || "");

  document.getElementById("company").value = row[3] || "";
  document.getElementById("name").value = row[4] || "";
  document.getElementById("phone").value = row[5] || "";
  document.getElementById("email").value = row[6] || "";
  document.getElementById("method").value = row[7] || "";
  document.getElementById("status").value = row[8] || "";

  document.getElementById("notes").value = "";

  const hint = document.getElementById("existingNotesHint");
  if (currentRowNotes.trim()) {
    hint.style.display = "block";
    hint.innerHTML =
      `This record already has notes. Use <span class="note-cell" data-notes-b64="${toB64Utf8(currentRowNotes)}">View Note</span> to read them. Add a new note above to append with today’s date.`;
  } else {
    hint.style.display = "none";
    hint.textContent = "";
  }

  document.getElementById("formSection").style.display = "block";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function saveLead(){
  const token = getToken();
  if(!token){ showLogin(); return; }

  const body = {
    action: "saveLead",
    token,
    row: editRow,
    company: document.getElementById("company").value,
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
    method: document.getElementById("method").value,
    status: document.getElementById("status").value,
    newNote: document.getElementById("notes").value.trim()
  };

  if(!body.company || body.company === "__add__"){ alert("Select a company."); return; }
  if(!body.name){ alert("Contact name is required."); return; }
  if(!body.status){ alert("Select a status."); return; }

  try{
    const res = await fetch(scriptURL, { method:"POST", body: JSON.stringify(body) });
    const out = await res.json();

    if(out.result === "duplicate"){
      alert("Duplicate email or phone exists!");
      return;
    }
    if(out.error){
      alert(out.error);
      logout();
      return;
    }

    alert("Saved!");
    editRow = null;
    currentRowNotes = "";

    document.getElementById("company").value = "";
    document.getElementById("name").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("email").value = "";
    document.getElementById("method").value = "";
    document.getElementById("status").value = "";
    document.getElementById("notes").value = "";
    document.getElementById("existingNotesHint").style.display = "none";

    document.getElementById("formSection").style.display = "none";
    loadLeads();

  }catch(err){
    console.error("Failed to save lead:", err);
    alert("Save failed. Network may be blocking Apps Script.");
  }
}
</script>

</body>
</html>



