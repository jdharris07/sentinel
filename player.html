<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentinel Trivia - Player</title>
  <style>
    :root{
      --brand:#6dc84d; --bg:#0b1220; --panel:#111827; --panel2:#0f172a;
      --border:#263244; --text:#e5e7eb; --muted:#94a3b8; --bad:#ef4444;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:radial-gradient(900px 500px at 10% 0%, rgba(109,200,77,.20), transparent 60%), var(--bg); color:var(--text);}
    .wrap{max-width:860px;margin:0 auto;padding:18px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--brand); box-shadow: 0 0 0 4px rgba(109,200,77,.12);}
    .title{font-weight:900;letter-spacing:.2px;}
    .card{background:linear-gradient(180deg, rgba(17,24,39,.92), rgba(17,24,39,.84)); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow: 0 18px 40px rgba(0,0,0,.35);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:680px){.grid{grid-template-columns:1fr;}}
    input,textarea,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border); background: #0b1220; color:var(--text); outline:none;}
    input:focus,textarea:focus,select:focus{border-color: rgba(109,200,77,.75); box-shadow:0 0 0 4px rgba(109,200,77,.12);}
    textarea{min-height:92px;resize:vertical;}
    button{background:var(--brand); color:#05210a; border:none; font-weight:900; cursor:pointer;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .btn-dark{background:#0b1220;color:var(--brand);border:1px solid var(--border);}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--border); border-radius:999px; background:#0b1220;color:var(--muted); font-size:13px;}
    .row{display:flex;gap:10px;flex-wrap:wrap; align-items:center;}
    .muted{color:var(--muted); font-size:13px; line-height:1.35;}
    .ok{color:var(--brand); font-weight:900;}
    .bad{color:#fca5a5; font-weight:900;}
    .lock{background:#3b0b10;border:1px solid rgba(239,68,68,.4); color:#fecaca;}
    .footer{margin-top:10px;color:var(--muted);font-size:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div class="title">Sentinel Trivia</div>
          <div class="muted">Player Answer Portal</div>
        </div>
      </div>
      <div class="pill" id="statePill">Connecting…</div>
    </div>

    <!-- JOIN -->
    <div class="card" id="joinCard">
      <div class="muted" style="margin-bottom:10px;">Enter your team name. If the host set a PIN, enter it too.</div>
      <div class="grid">
        <input id="teamName" placeholder="Team name (e.g., Quiztopher Columbus)" maxlength="40" />
        <input id="pin" placeholder="Game PIN (if required)" inputmode="numeric" maxlength="10" />
      </div>
      <div style="margin-top:10px;">
        <button id="joinBtn" onclick="join()">Join Game</button>
      </div>
      <div class="footer" id="joinMsg"></div>
    </div>

    <!-- PLAY -->
    <div class="card" id="playCard" style="display:none; margin-top:12px;">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <div class="pill"><span>Team:</span> <strong id="teamLabel"></strong></div>
        <button class="btn-dark" style="max-width:170px;" onclick="resetTeam()">Change Team</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <div class="pill" id="roundPill">Round ?</div>
        <div class="pill" id="openPill">Status: …</div>
        <div class="pill" id="savedPill">Saved: —</div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <select id="questionSel" onchange="switchQuestion()"></select>
        <button class="btn-dark" style="max-width:160px;" onclick="loadMyRoundAnswers()">Refresh</button>
      </div>

      <textarea id="answer" placeholder="Type your answer here…"></textarea>

      <div class="row" style="margin-top:10px;">
        <button id="submitBtn" onclick="submitAnswer()">Save Answer</button>
        <button class="btn-dark" style="max-width:220px;" onclick="saveBlank()">Save Blank (Don’t Know)</button>
      </div>

      <div class="footer" id="playMsg"></div>
    </div>
  </div>

<script>
  const API = "https://script.google.com/macros/s/AKfycbxz93zA4ttM0W7mxdVF3-SLmUpnMBvHRXeXpNZH2AYlpO4iW2o62pStQPvpT7v750OS/exec";

  // ---- JSONP ----
  function jsonp(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cbName = "STCB_" + Math.random().toString(36).slice(2);

      const url = new URL(API);
      url.searchParams.set("action", action);
      url.searchParams.set("callback", cbName);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, (v==null) ? "" : String(v)));

      let done = false;
      let timer = null;
      const scriptEl = document.createElement("script");

      function cleanup() {
        if (done) return;
        done = true;
        try { delete window[cbName]; } catch(e) {}
        if (timer) clearTimeout(timer);
        if (scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl);
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      scriptEl.onerror = () => { cleanup(); reject(new Error("JSONP network error")); };

      timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, 12000);

      scriptEl.src = url.toString();
      document.head.appendChild(scriptEl);
    });
  }

  // ---- device token ----
  function getDeviceToken() {
    let t = localStorage.getItem("st_device");
    if (!t) {
      t = "D" + crypto.getRandomValues(new Uint32Array(4)).join("").slice(0,18);
      localStorage.setItem("st_device", t);
    }
    return t;
  }

  function setTeamSession(teamId, teamName){
    localStorage.setItem("st_teamId", teamId);
    localStorage.setItem("st_teamName", teamName);
  }
  function getTeamSession(){
    return {
      teamId: localStorage.getItem("st_teamId") || "",
      teamName: localStorage.getItem("st_teamName") || ""
    };
  }
  function clearTeamSession(){
    localStorage.removeItem("st_teamId");
    localStorage.removeItem("st_teamName");
  }

  // ---- UI refs ----
  const statePill = document.getElementById("statePill");
  const joinCard = document.getElementById("joinCard");
  const playCard = document.getElementById("playCard");
  const joinMsg = document.getElementById("joinMsg");
  const playMsg = document.getElementById("playMsg");
  const teamLabel = document.getElementById("teamLabel");
  const roundPill = document.getElementById("roundPill");
  const openPill = document.getElementById("openPill");
  const savedPill = document.getElementById("savedPill");
  const submitBtn = document.getElementById("submitBtn");
  const answerEl = document.getElementById("answer");
  const questionSel = document.getElementById("questionSel");

  let lastState = null;
  let myAnswers = {};     // { "1": "abc", "2": "" ... }
  let currentQ = 1;

  function setStateUI(s){
    lastState = s;
    roundPill.textContent = `Round ${s.round}`;
    openPill.textContent = s.isOpen ? "Status: OPEN" : "Status: LOCKED";
    openPill.className = s.isOpen ? "pill" : "pill lock";
    statePill.textContent = s.isOpen ? `OPEN • Round ${s.round}` : `LOCKED • Round ${s.round}`;

    submitBtn.disabled = !s.isOpen;
    answerEl.disabled = !s.isOpen;

    if (!s.isOpen) answerEl.placeholder = "Locked. Round ended.";
    else answerEl.placeholder = "Type your answer here…";

    buildQuestionDropdown(s.questionsPerRound || 15);
  }

  function buildQuestionDropdown(qCount){
    const existing = questionSel.options.length;
    if (existing === qCount) return;

    questionSel.innerHTML = "";
    for(let i=1;i<=qCount;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `Question ${i}`;
      questionSel.appendChild(opt);
    }
    if(currentQ < 1) currentQ = 1;
    if(currentQ > qCount) currentQ = qCount;
    questionSel.value = String(currentQ);
  }

  async function refreshState(){
    try{
      const res = await jsonp("getState");
      if(res.ok) setStateUI(res.state);
    }catch(e){
      statePill.textContent = "Offline / blocked network";
    }
  }

  async function join(){
    joinMsg.textContent = "";
    const teamName = document.getElementById("teamName").value.trim();
    const pin = document.getElementById("pin").value.trim();
    if(!teamName){ joinMsg.innerHTML = `<span class="bad">Team name required.</span>`; return; }

    try{
      const out = await jsonp("joinTeam", {
        teamName,
        pin,
        deviceToken: getDeviceToken()
      });

      if(!out.ok){
        joinMsg.innerHTML = `<span class="bad">${escapeHtml(out.error || "Join failed.")}</span>`;
        return;
      }

      setTeamSession(out.team.teamId, out.team.teamName);
      showPlay();

    }catch(e){
      joinMsg.innerHTML = `<span class="bad">Network error (maybe blocked Wi-Fi). Try mobile data.</span>`;
    }
  }

  function showPlay(){
    const sess = getTeamSession();
    teamLabel.textContent = sess.teamName || "";
    joinCard.style.display = "none";
    playCard.style.display = "block";
    playMsg.textContent = "";
    refreshState();
    loadMyRoundAnswers();
  }

  function resetTeam(){
    clearTeamSession();
    joinCard.style.display = "block";
    playCard.style.display = "none";
    document.getElementById("teamName").value = "";
    document.getElementById("pin").value = "";
    playMsg.textContent = "";
    joinMsg.textContent = "";
  }

  async function loadMyRoundAnswers(){
    const sess = getTeamSession();
    if(!sess.teamId) return;

    try{
      const out = await jsonp("getMyRoundAnswers", {
        teamId: sess.teamId,
        deviceToken: getDeviceToken()
      });

      if(!out.ok){
        playMsg.innerHTML = `<span class="bad">${escapeHtml(out.error || "Failed.")}</span>`;
        return;
      }

      // in case state changed
      if(lastState && typeof out.isOpen === "boolean"){
        setStateUI({ ...lastState, isOpen: out.isOpen, round: out.round });
      }

      myAnswers = out.answers || {};
      // keep currentQ but clamp if needed
      const qCount = (lastState && lastState.questionsPerRound) ? lastState.questionsPerRound : 15;
      if(currentQ > qCount) currentQ = qCount;

      questionSel.value = String(currentQ);
      answerEl.value = (myAnswers[String(currentQ)] ?? "");
      updateSavedPill();

      if(out.isOpen === false){
        playMsg.innerHTML = `<span class="bad">Round locked.</span> You can’t edit answers right now.`;
      }else{
        playMsg.textContent = "";
      }

    }catch(e){
      playMsg.innerHTML = `<span class="bad">Network error.</span>`;
    }
  }

  function updateSavedPill(){
    const v = (myAnswers[String(currentQ)] ?? "");
    if(v.trim().length === 0){
      savedPill.textContent = "Saved: (blank)";
    }else{
      savedPill.textContent = "Saved: ✓";
    }
  }

  function switchQuestion(){
    currentQ = Number(questionSel.value) || 1;
    answerEl.value = (myAnswers[String(currentQ)] ?? "");
    updateSavedPill();
    playMsg.textContent = "";
  }

  async function submitAnswer(){
    const sess = getTeamSession();
    const answer = answerEl.value; // allow blank
    playMsg.textContent = "";

    try{
      const out = await jsonp("submitAnswer", {
        teamId: sess.teamId,
        deviceToken: getDeviceToken(),
        question: String(currentQ),
        answer: answer
      });

      if(out.ok){
        myAnswers[String(currentQ)] = answer;
        updateSavedPill();
        playMsg.innerHTML = `<span class="ok">Saved!</span> Q${currentQ} updated.`;
      } else if(out.locked) {
        playMsg.innerHTML = `<span class="bad">Locked.</span> Round is closed.`;
        refreshState();
      } else {
        playMsg.innerHTML = `<span class="bad">${escapeHtml(out.error || "Save failed.")}</span>`;
      }
    }catch(e){
      playMsg.innerHTML = `<span class="bad">Network error.</span>`;
    }
  }

  function saveBlank(){
    answerEl.value = "";
    submitAnswer();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---- boot ----
  (function init(){
    const sess = getTeamSession();
    if(sess.teamId) showPlay();
    refreshState();
    setInterval(refreshState, 5000);
    setInterval(() => { if(getTeamSession().teamId) loadMyRoundAnswers(); }, 8000);
  })();
</script>
</body>
</html>

