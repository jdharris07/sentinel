<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>LCARS • Subspace Scope Intercept</title>
<style>
  :root{
    --bg:#000; --text:#FFCC66; --panel:#330000; --panel2:#663300; --outline:#FFCC66;
    --ok:#88FF88; --muted:#cda96b; --accent:#9fd6ff;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:monospace}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .banner{display:flex;justify-content:space-between;align-items:center;border:2px solid var(--outline);
    padding:10px 14px;border-radius:12px;background:var(--panel);gap:12px;flex-wrap:wrap}
  .badge{font-weight:bold}
  h1,h2{margin:12px 0}

  .panel{border:2px solid var(--outline);background:var(--panel2);border-radius:12px;padding:14px;box-shadow:0 0 12px #ffcc6680}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .ok{color:var(--ok);font-weight:bold}

  .scopeShell{position:relative}
  .scope{height:240px;border:2px solid var(--outline);border-radius:10px;background:#0e0a0a;position:relative;overflow:hidden}
  #scope{width:100%;height:100%}

  /* meters */
  .meter{height:16px;border:2px solid var(--outline);border-radius:8px;background:#1b0d0d;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#5bff8a,#ffd27a,#ff6d6d)}
  .lockShell{height:20px;border:2px solid var(--outline);border-radius:10px;background:#1b0d0d;overflow:hidden}
  .lockBar{height:100%;width:0%;background:linear-gradient(90deg,#88ff88,#66ffaa,#33ffaa)}

  /* Start overlay over the scope */
  .startOverlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.65); backdrop-filter: blur(1px);
  }
  .startOverlay button{
    background:var(--text); color:#2b1400; border:none; border-radius:24px; padding:10px 18px;
    font-weight:bold; cursor:pointer; box-shadow:0 0 10px #ffcc6680;
  }
  .startOverlay button:hover{ filter:brightness(1.08) }

  /* controls */
  input[type=range]{appearance:none;width:100%;height:16px;border-radius:10px;background:#241010;border:2px solid var(--outline)}
  input[type=range]::-webkit-slider-thumb{appearance:none;width:24px;height:24px;border-radius:50%;background:#FFCC66;border:2px solid #2b1400}
  input[type=range]::-moz-range-thumb{width:24px;height:24px;border:none;border-radius:50%;background:#FFCC66}

  .type{min-height:6em;white-space:pre-wrap}
  .delta{font-weight:bold; text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <div class="banner">
    <div>LCARS • SUBSPACE INTERCEPT • <span class="badge">SCOPE FOLLOW MODE</span></div>
    <div>Window: <span id="winLabel">±14 px</span> • Gain: <span id="gainLabel">1.4x</span></div>
  </div>

  <h1>Deep Space Intercept — Horizontal Scope</h1>
  <div class="muted" style="margin-top:6px;margin-bottom:10px">
    Use the <b>tuner</b> slider to align the receiver line inside the shaded band. Staying in-band fills the progress meter.
  </div>

  <div class="panel">
    <h2>Receiver Scope</h2>
    <div class="scopeShell">
      <div class="scope" id="scopeBox">
        <canvas id="scope"></canvas>
        <!-- Start overlay sits on top of the scope and disappears after click -->
        <div class="startOverlay" id="startOverlay"><button id="startBtn">Start Intercept</button></div>
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div style="flex:1">
        <div class="muted">TUNER (↑/↓ keys)</div>
        <input id="tuner" type="range" min="-1" max="1" step="0.01" value="0"/>
      </div>
      <div style="width:240px">
        <div class="muted">Proximity</div>
        <div class="meter"><div id="proxBar" class="bar"></div></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Intercept Progress</div>
      <div class="lockShell"><div id="lockBar" class="lockBar"></div></div>
    </div>

    <div id="status" class="muted" style="margin-top:8px">Status: Idle.</div>
    <div class="row" style="margin-top:8px">
      <button id="mute">Audio: On</button>
    </div>
  </div>
</div>

<!-- AUDIO: your own static + the intercepted audio -->
<audio id="staticAudio" src="static.mp3" preload="auto" loop></audio>
<audio id="voiceAudio"  src="audiorec.mp3" preload="auto" loop></audio>

<script>
/* ===== FIXED DIFFICULTY SETTINGS (middle) ===== */
const LOCK_WINDOW_PX = 14;   // same “middle” window half-height you used before
const GAIN = 1.4;            // signal speed/complexity similar to your mid value
const TIME_GOAL_SECONDS = 50;
const PROGRESS_PER_SECOND = 100 / TIME_GOAL_SECONDS;
const VOICE_RATE = 0.95;

/* ===== STATE ===== */
let running = false, locked = false, muted = false;
let last = 0, t = 0;
let timeInSignal = 0;
let secondCounter = 0;
let tunerY = 0; // -1..1

/* ===== DOM ===== */
const scope = document.getElementById('scope');
const ctx = scope.getContext('2d');
const scopeBox = document.getElementById('scopeBox');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const tuner = document.getElementById('tuner');
const proxBar = document.getElementById('proxBar');
const lockBar = document.getElementById('lockBar');
const status = document.getElementById('status');
const muteBtn = document.getElementById('mute');
const winLabel = document.getElementById('winLabel');
const gainLabel = document.getElementById('gainLabel');

const staticAudio = document.getElementById('staticAudio');
const voiceAudio  = document.getElementById('voiceAudio');

/* ===== SIZE ===== */
function resize(){ scope.width = scope.clientWidth; scope.height = scope.clientHeight; }
window.addEventListener('resize', resize);

/* ===== SIGNAL MODEL ===== */
function signalY(timeN){
  return 0.5*Math.sin(2*Math.PI*(timeN*0.10))
       + 0.35*Math.sin(2*Math.PI*(timeN*0.20 + 0.2))
       + 0.15*Math.sin(2*Math.PI*(timeN*0.04 + 0.6));
}

/* ===== AUDIO HELPERS ===== */
function tryPlay(audio){
  return audio.play()?.catch(()=>{/* ignore autoplay errors until user interacts */});
}
function ensureStaticOn(){
  staticAudio.volume = 1.0;
  if (staticAudio.paused) { staticAudio.currentTime = 0; tryPlay(staticAudio); }
}
function ensureVoiceOn(){
  voiceAudio.volume = 1.0;
  if (voiceAudio.paused) { voiceAudio.currentTime = 0; tryPlay(voiceAudio); }
}
function duckStatic(){
  staticAudio.volume = 0.25;
}
function unduckStatic(){
  staticAudio.volume = 1.0;
}
function stopAllAudio(){
  [staticAudio, voiceAudio].forEach(a=>{ a.pause(); a.currentTime = 0; });
}

/* ===== DRAW LOOP ===== */
function drawScope(dt){
  const W = scope.width, H = scope.height;
  ctx.fillStyle = "#0c0a0a"; ctx.fillRect(0,0,W,H);

  // grid
  ctx.strokeStyle = "#442"; ctx.lineWidth = 1;
  for (let x=0; x<W; x+=Math.floor(W/12)){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for (let y=0; y<H; y+=Math.floor(H/8)){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  // positions
  const windowPx = LOCK_WINDOW_PX;
  const sigYNorm = signalY(t*GAIN);
  const sigY = H/2 + sigYNorm*(H*0.42);
  const tunerPx = H/2 + tunerY*(H*0.45);

  // window band
  ctx.fillStyle = "rgba(255,204,102,0.12)";
  ctx.fillRect(0, sigY - windowPx, W, windowPx*2);

  // trace
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#ffd27a";
  ctx.beginPath();
  for (let x=0; x<W; x++){
    const tt = (t - (W-x)/140);
    const y = H/2 + signalY(tt*GAIN)*(H*0.42);
    if (x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // current signal dot
  ctx.fillStyle = "#88ff88";
  ctx.beginPath(); ctx.arc(W-6, sigY, 4, 0, Math.PI*2); ctx.fill();

  // tuner line
  ctx.strokeStyle = locked ? "#7cff7c" : "#9fd6ff";
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0, tunerPx); ctx.lineTo(W, tunerPx); ctx.stroke();

  // proximity meter
  const delta = Math.abs(tunerPx - sigY);
  const inBand = (delta <= windowPx);
  const p = Math.max(0, 1 - (delta / Math.max(1, windowPx)));
  proxBar.style.width = (p*100).toFixed(1) + "%";

  // audio crossfade-ish
  if (!muted && running && !locked){
    if (inBand){ ensureVoiceOn(); duckStatic(); }
    else { voiceAudio.pause(); voiceAudio.currentTime = 0; unduckStatic(); ensureStaticOn(); }
  }

  // progress accumulation
  if (running && !locked && inBand){
    secondCounter += dt;
    while (secondCounter >= 1){
      secondCounter -= 1;
      timeInSignal += 1;
      const prog = Math.min(100, timeInSignal * PROGRESS_PER_SECOND);
      lockBar.style.width = prog.toFixed(1) + "%";
      if (prog >= 100){ doLock(); break; }
    }
  }
}

function loop(now){
  const n = now/1000;
  const dt = last ? n - last : 0;
  last = n;
  t += dt;
  if (!locked){ drawScope(dt); }
  requestAnimationFrame(loop);
}

/* ===== ACTIONS ===== */
function start(){
  if (running) return;
  running = true;
  status.textContent = "Receiver online. Keep your tuner inside the shaded window to accumulate progress.";
  resize(); last = 0;
  // kick audio
  if (!muted){ ensureStaticOn(); }
  requestAnimationFrame(loop);
  // remove overlay
  startOverlay.style.display = 'none';
}

function doLock(){
  locked = true;
  running = false;

  // stop scanning audio, stop voice too
  stopAllAudio();

  status.innerHTML = '<span class="ok">Lock acquired. Decoding…</span>';

  // replace scope with the final message
  scopeBox.innerHTML = `
    <div style="padding:16px; text-align:center;">
      <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">COMMUNICATIONS LOCK-ON COMPLETE.</div>
      <div>REFERENCE RECALL CODE: <span class="delta">DELTA1701</span> FOR MORE INFORMATION.</div>
    </div>
  `;
  // optional: small chime via speechSynthesis (will obey mute)
  if (!muted){
    const u = new SpeechSynthesisUtterance("Communications lock-on complete. Reference recall code: Delta one seven zero one.");
    u.rate = VOICE_RATE;
    speechSynthesis.speak(u);
  }
}

/* ===== EVENTS ===== */
startBtn.addEventListener('click', () => { start(); });

tuner.addEventListener('input', ()=>{ tunerY = +tuner.value; });
document.addEventListener('keydown', (e)=>{
  if (!running || locked) return;
  if (e.key === 'ArrowUp'){ tunerY = Math.max(-1, tunerY - 0.02); tuner.value = tunerY.toFixed(2); }
  if (e.key === 'ArrowDown'){ tunerY = Math.min( 1, tunerY + 0.02); tuner.value = tunerY.toFixed(2); }
});

muteBtn.addEventListener('click', ()=>{
  muted = !muted;
  muteBtn.textContent = "Audio: " + (muted ? "Off" : "On");
  if (muted){ stopAllAudio(); try{ speechSynthesis.cancel(); }catch{} }
  else if (running && !locked){ ensureStaticOn(); }
});

/* ===== INIT ===== */
window.addEventListener('load', ()=>{
  resize();
  winLabel.textContent = "±" + LOCK_WINDOW_PX.toFixed(0) + " px";
  gainLabel.textContent = GAIN.toFixed(1) + "x";
  // prime voices (some browsers require)
  try { speechSynthesis.getVoices(); } catch {}
});
</script>
</body>
</html>
