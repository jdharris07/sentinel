<!DOCTYPE html>
<html>
<head>
  <title>COMPAS Interface</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <link rel="stylesheet" type="text/css" href="classic.css">
  <style>
    #intro-text { white-space: pre-wrap; }
    #chat-box {
      padding: 20px;
      max-width: 600px;
      margin: 20px auto;
      background-color: #663300;
      border-radius: 20px;
      color: #FFCC66;
      box-shadow: 0 0 15px #FFCC66AA;
      height: 400px;
      overflow-y: auto;
    }
    .entry { margin-bottom: 15px; }
    .player { color: #88FF88; }
    .compas { color: #FFCC66; white-space: pre-wrap; }
    #input-area {
      display: flex; justify-content: center; margin-top: 10px; flex-wrap: wrap;
    }
    #user-input {
      flex: 1; min-width: 60%; padding: 8px; font-size: 16px;
      border-radius: 10px; border: 2px solid #FFCC66; background: #330000; color: #FFCC66; margin-bottom: 10px;
    }
    button {
      padding: 8px 20px; border-radius: 20px; background-color: #FFCC66; border: none;
      color: #330000; font-weight: bold; cursor: pointer; font-size: 16px; margin-left: 8px;
    }
    button:hover { background-color: #FFD97F; }
    #voice-toggle { margin-top: 10px; display: block; margin-left: auto; margin-right: auto; }

    /* Action buttons row */
    .actions-row{
      max-width: 600px; margin: 0 auto 8px auto; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
    }
    .task-btn{
      border-radius: 16px; padding: 10px 14px; border: 2px solid #FFCC66; background:#402000; color:#FFCC66;
      box-shadow: 0 0 8px #FFCC6644 inset;
    }
    .task-btn[disabled]{
      background:#153a25; border-color:#7cffb6; color:#b6ffd9; cursor: default;
    }

    /* Inline form host */
    #form-host{ max-width: 600px; margin: 0 auto 16px auto; }
    .inline-card{
      background:#402000; color:#FFCC66; border:2px solid #FFCC66; border-radius:16px; padding:12px;
      box-shadow:0 0 12px #FFCC6644 inset;
    }
    .inline-card h3{ margin: 0 0 10px 0; font-size: 18px; }
    .inline-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .inline-row > *{ flex:1 }
    .inline-card label{ display:block; font-size:13px; margin-bottom:4px; opacity:.9 }
    .inline-card input{
      width:100%; padding:10px; border-radius:10px; border:2px solid #FFCC66; background:#330000; color:#FFCC66;
    }
    .inline-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .muted{ opacity:.85; font-size: 13px; }
    .feedback{ margin-top:8px; font-size: 14px; }
    .ok{ color:#b6ffd9 }
    .warn{ color:#ffe28f }
    .err{ color:#ffd0d0 }

    /* Phase 2 layout */
    .phase2{
      max-width: 700px; margin: 30px auto 10px auto; background:#331a00; border-radius: 20px; padding:20px;
      color:#FFCC66; box-shadow: 0 0 15px #FFCC66AA;
      text-align:center;
    }
    .phase2 h2{ margin-top:0; }
    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #FFCC66; margin:4px;
      background:#402000;
    }
    .pill.ok{ background:#153a25; border-color:#7cffb6; color:#b6ffd9; }
    .task-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin:12px 0 8px 0;
    }
    .note { font-size: 13px; opacity:.9; }

    /* Gate message button inside chat */
    .gate-wrap{ margin-top:8px; text-align:right; }
    .gate-btn{
      border-radius: 12px; padding:6px 10px; border: 2px solid #FFCC66;
      background:#402000; color:#FFCC66; cursor:pointer;
    }
    .gate-btn:hover{ background:#4b2a00; }
  </style>
</head>
<body>
  <div class="wrap-everything">
    <section id="column-3">
      <div class="wrap">
        <div class="left-frame-top">
          <div class="panel-1 static-panel"></div>
          <div class="panel-2 static-panel">&nbsp;</div>
        </div>
        <div class="right-frame-top">
          <div class="banner"> LCARS • 58814.6 </div>
          <div class="bar-panel first-bar-panel">
            <div class="bar-1"></div><div class="bar-2"></div><div class="bar-3"></div><div class="bar-4"></div><div class="bar-5"></div>
          </div>
        </div>
      </div>
      <main id="main-root">
        <h1>COMPAS Assistance Console</h1>

        <!-- Phase 1 Action buttons -->
        <div class="actions-row" id="actions">
          <button id="btnTimeline" class="task-btn">Submit the timeline of the murder</button>
          <button id="btnCause" class="task-btn">Submit Cause of Death</button>
        </div>

        <!-- Inline form host -->
        <div id="form-host"></div>

        <!-- CHAT stays on both phases -->
        <div id="chat-box">
          <div class="entry compas" id="intro-text">Greetings. I am the Federation’s Central Operations Management and Protocol Assistance System — COMPAS. My primary functions aboard this station include coordinating critical systems, monitoring compliance with Starfleet protocols, and providing operational support to personnel… and occasionally reminding the Captain to hydrate.

I will assist you in your investigation to the best of my capacity, though my responses may be limited as the station is preparing for the Tandaran fleet's arrival. It appears the logical next step is for you to determine the posion used as well as the timeline.</div>
        </div>

        <div id="input-area">
          <input type="text" id="user-input" placeholder="Type your message here..." />
          <button onclick="handleInput()">Send</button>
        </div>
        <button id="voice-toggle">Voice: On</button>
      </main>
    </section>
  </div>

  <script>
    const chat = document.getElementById("chat-box");
    const voiceToggle = document.getElementById("voice-toggle");
    const mainRoot = document.getElementById("main-root");
    const btnTimeline = document.getElementById("btnTimeline");
    const btnCause = document.getElementById("btnCause");
    const formHost = document.getElementById("form-host");

    let voiceEnabled = true;

    // ====== Persistent state ======
    const LS_KEY = "compas_progress_v9"; // same key; we add a field
    const stateDefault = {
      timelineDone:false,
      causeDone:false,
      // Phase 2 objectives:
      utDone:false,       // Universal Translator Code
      wiringDone:false,   // Wiring the Dabo Wheel
      commsDone:false,    // Unauthorized Deep Space Communication
      codedDone:false,    // Who wrote the coded message?
      phase2GateAck:false,
      // Hints:
      hintSteps:{},
      lastHintTopic:null
    };
    let progress = loadProgress();

    function loadProgress(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? Object.assign({}, stateDefault, JSON.parse(raw)) : {...stateDefault};
      }catch(e){ return {...stateDefault}; }
    }
    function saveProgress(){
      localStorage.setItem(LS_KEY, JSON.stringify(progress));
    }

    // Render guard to prevent duplicate Phase 2 UI
    let phase2Rendered = false;

    // Chat state features
    let patchHintStep = 0; // legacy patch hints (kept)
    let submissionStep = 0;
    let submittedCause = "";
    let submittedStart = "";
    let submittedEnd = "";
    let causeSubmitMode = false;

    // Chat-only timeline stepper (still supported)
    let timelineMode = 0;
    let timelineStart = "";

    const patchHints = [
      "The Tandaran insignia is not just decorative; it may serve as a key overlay to hidden information.",
      "Consider using the numbered points on the patch to guide your reading order.",
      "The patch points can align with specific marks or clues on the letterhead. Try moving it carefully to see where they match.",
      "There may be multiple ways to place the patch. Only one sequence will reveal a clear message when read in numerical order from 1 to 7.",
      "When correctly placed, the message will read clearly across the points in order. You are seeking something that resembles a passcode for Taldare."
    ];

    // ====== HINT ENGINE ======
    const HINTS = {
      cause: [
        "Examine the available evidence, including the plate found in the victim’s room.",
        "Try a multi-spectrum check — the provided flashlight emits ultraviolet.",
        "Shine the UV light on the plate to reveal chemical symbols.",
        "Those symbols match items on the chemical analysis paper.",
        "Use the paper’s rules to determine the correct order and submit that sequence.",
        "The first chemical in the sequence is “C”."
      ],
      timeline: [
        "Check all of the medical tricorder readouts for time markers.",
        "Write down each time mentioned to keep track of the window.",
        "The timeline begins at 1300."
      ],
      wiring: [
        "Revisit Nodor’s Dabo wheel hardware — the wiring solution is hidden in plain sight.",
        "Focus on connecting the wires, ignore the numbers.",
        "Enter the result as one uninterrupted sequence of digits when you think you have it. The sequence begins with 2 then 8."
      ],
      comms: [
        "Use the radio scope to keep the tuner line inside the shaded band.",
        "Staying in-band steadily fills the intercept progress meter.",
        "After lock-on, read the recall code carefully — you’ll need it later."
      ],
      // coded-message / patch hints
      coded: [
        "The delta patch was found with the coded message.",
        "The star symbol on the message is similar to the one in the center of the patch.",
        "Place the patch onto the star and note how the points on the patch line up with the letters.",
        "Read them in the order of the numbers 1–3.",
        "Move the patch left to right / top to bottom across the page to reveal the hidden message.",
        "The message begins with “KYR MEET”…"
      ]
    };

    // Aliases map: keyword => topic key in HINTS
    const HINT_ALIASES = [
      {rx: /(cause|weapon|weapon used|chemical|chem|analysis)/, topic: "cause"},
      {rx: /(timeline|time window|time-line)/, topic: "timeline"},
      {rx: /(wiring|dabo|dabo wheel|nodor|wheel)/, topic: "wiring"},
      {rx: /(comms|communication|radio|intercept|scope)/, topic: "comms"},
      {rx: /(coded|message|coded message|patch|delta patch|paper|letterhead|star)/, topic: "coded"}
    ];

    function normalizeTopic(msg){
      for (const a of HINT_ALIASES){
        if (a.rx.test(msg)) return a.topic;
      }
      return null;
    }

    function hintHelpText(){
      return `Hint protocol online. To request: type “hint <puzzle>” — e.g., “hint cause of death”, “wiring hint”, “hint timeline”, “hint comms”, or “hint coded message”. After I give a hint, type “more” for the next one.`;
    }

    function deliverHint(topic){
      const list = HINTS[topic] || [];
      const idx = (progress.hintSteps[topic] || 0);
      if (idx >= list.length){
        addResponse("No further hints available for that topic.");
        return;
      }
      const text = list[idx];
      progress.hintSteps[topic] = idx + 1;
      progress.lastHintTopic = topic;
      saveProgress();
      addTitledResponse("HINT — " + topic.toUpperCase(), text);
    }

    const responses = {
      "getting started": "I would be glad to help. I would start by reviewing the medical tricorder readings from the victim's body. Scan the QR code on the sheet with his picture. From there, the clues should help you determine the timeline for the murder. After that, conduct a chemical analysis on the victim's plate. Good luck, investigator!",
      "help": "I recommend beginning by interviewing each suspect carefully. Observe their statements for inconsistencies or hidden motives.\n\nAdditionally, look for secured data modules and encoded documents hidden throughout the station. These may contain vital clues when properly decoded.\n\nReturn to me anytime for further guidance.",
      "janeway": "Kathryn Janeway commanded the USS Voyager during its Delta Quadrant odyssey, later becoming a respected figure in Starfleet command and strategy circles.",
      "picard": "Jean-Luc Picard is a legendary Starfleet captain and diplomat, known for his critical role in numerous key negotiations and crises.",
      "kirk": "James T. Kirk was a pivotal Starfleet captain, renowned for his bold tactics and first-contact missions during the early days of Federation expansion.",
      "sisko": "Benjamin Sisko was the commanding officer of Deep Space Nine and played a major role during the Dominion War, shaping the balance of power in the quadrant.",
      "spock": "Spock served as science officer and later ambassador, bridging Vulcan logic and human intuition in countless missions and diplomatic efforts.",
      "enterprise": "The USS Enterprise has a long and storied history, representing the ideals of exploration and diplomacy. It remains one of Starfleet's most iconic starships.",
      "voyager": "The USS Voyager returned from its 70,000-light-year journey through the Delta Quadrant, greatly influencing current Federation diplomacy and technological advancement.",
      "station": "Starbase Sentinel is a highly advanced modular station, featuring diplomatic suites, tactical command centers, and research facilities. It serves as the focal point for Federation–Tandaran negotiations.",
      "starbase sentinel": "Starbase Sentinel is positioned just outside Tandaran space, serving as a diplomatic and tactical outpost on the edge of the Alpha Quadrant.",
      "submit forensic info": "Understood. Please enter the suspected cause of death first (e.g., poisoning or food poisoning).",
      "hello": "Hello, investigator. How may I help you?",
      "dragon con": "I have heard of this gathering that occurs annually on Earth. Rumor has it the best track there is the Trek track.",
      "submit cause of death": "Acknowledged. Please submit the cause of death.",
      "submit timeline": "Acknowledged. Please enter the start time (e.g., 1300). You may also enter both as 1300-1440.",
      "hint": hintHelpText()
    };

    const suspectKeywords = {
      "jora": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "tell": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "jora tell": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "nira": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "vess": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "nira vess": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "dalra": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "gil": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "gil dalra": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "lorr": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "vun": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "lorr vun": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "renn": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "vok": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "renn vok": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "eno": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review.",
      "tavik": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review.",
      "eno tavik": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review."
    };

    // ====== UI helpers ======
    function setButtonState(){
      if (progress.timelineDone){
        btnTimeline.textContent = "COMPLETED";
        btnTimeline.disabled = true;
      } else {
        btnTimeline.textContent = "Submit the timeline of the murder";
        btnTimeline.disabled = false;
      }
      if (progress.causeDone){
        btnCause.textContent = "COMPLETED";
        btnCause.disabled = true;
      } else {
        btnCause.textContent = "Submit Cause of Death";
        btnCause.disabled = false;
      }
    }

    function clearForm(){ formHost.innerHTML = ""; }

    // ====== PHASE 2 GATE & RENDER ======
    function maybeAdvanceToPhase2(){
      if (progress.timelineDone && progress.causeDone){
        if (!progress.phase2GateAck){
          postPhase2GateMessage();
        } else {
          renderPhase2();
        }
      }
    }

    function postPhase2GateMessage(){
      if (document.getElementById('gate-proceed')) return;

      const wrap = document.createElement("div");
      wrap.classList.add("entry","compas");
      wrap.innerHTML = `
SEE DEREK FOR MORE
<div class="gate-wrap"><button id="gate-proceed" class="gate-btn">Proceed</button></div>
      `;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;

      if (voiceEnabled){ speakText("SEE DEREK FOR MORE"); }

      document.getElementById('gate-proceed').addEventListener('click', ()=>{
        progress.phase2GateAck = true; saveProgress();
        chat.innerHTML = "";
        renderPhase2();
      });
    }

    function renderPhase2(){
      if (phase2Rendered) return;
      phase2Rendered = true;

      const actions = document.getElementById('actions');
      if (actions) actions.style.display = 'none';
      clearForm();

      if (!document.getElementById('phase2-panel')){
        const panel = document.createElement('div');
        panel.id = 'phase2-panel';
        panel.className = 'phase2';
        panel.innerHTML = `
          <h2>Secondary Objectives</h2>
          <div class="note">Complete each objective. When all are complete, you may close the case.</div>

          <div style="margin:10px 0 6px 0">
            <span class="pill ${progress.timelineDone && progress.causeDone ? 'ok':''}" id="pillP1">Phase 1 (Timeline & Cause)</span>
            <span class="pill ${progress.utDone ? 'ok':''}" id="pillUT">Universal Translator Code</span>
            <span class="pill ${progress.wiringDone ? 'ok':''}" id="pillWiring">Wiring the Dabo Wheel</span>
            <span class="pill ${progress.commsDone ? 'ok':''}" id="pillComms">Unauthorized Deep Space Communication</span>
            <span class="pill ${progress.codedDone ? 'ok':''}" id="pillCoded">Coded Message Author</span>
          </div>

          <div class="task-grid">
            <button id="btnUT" class="task-btn"${progress.utDone?' disabled':''}>Universal Translator Code</button>
            <button id="btnWiring" class="task-btn"${progress.wiringDone?' disabled':''}>Wiring the Dabo Wheel</button>
            <button id="btnComms" class="task-btn"${progress.commsDone?' disabled':''}>Unauthorized Deep Space Communication</button>
            <button id="btnCoded" class="task-btn"${progress.codedDone?' disabled':''}>Who wrote the coded message?</button>
          </div>

          <div id="phase2-form-host" style="max-width:600px;margin:0 auto 12px auto;"></div>

          <hr style="border:none;border-top:1px solid #FFCC66;opacity:.35;margin:16px 0 10px 0" />

          <button id="btnSolve" class="task-btn" ${isAllPhase2Ready() ? '' : 'disabled'}>Solved the Mystery & ready to close the case?</button>
          <div class="note" id="solveNote">${isAllPhase2Ready()
            ? 'All objectives complete. Click to proceed.'
            : 'This will unlock once the four objectives above are completed.'}</div>
        `;
        const chatBox = document.getElementById('chat-box');
        mainRoot.insertBefore(panel, chatBox);
      }

      document.getElementById('btnUT').addEventListener('click', showUTForm);
      document.getElementById('btnWiring').addEventListener('click', showWiringForm);
      document.getElementById('btnComms').addEventListener('click', showCommsForm);
      document.getElementById('btnCoded').addEventListener('click', showCodedForm);
      document.getElementById('btnSolve').addEventListener('click', showSolveForm);
    }

    function updatePills(){
      const p1 = document.getElementById('pillP1');
      const ut = document.getElementById('pillUT');
      const wi = document.getElementById('pillWiring');
      const co = document.getElementById('pillComms');
      const cm = document.getElementById('pillCoded');
      if (p1) p1.classList.toggle('ok', progress.timelineDone && progress.causeDone);
      if (ut) ut.classList.toggle('ok', progress.utDone);
      if (wi) wi.classList.toggle('ok', progress.wiringDone);
      if (co) co.classList.toggle('ok', progress.commsDone);
      if (cm) cm.classList.toggle('ok', progress.codedDone);

      const solve = document.getElementById('btnSolve');
      const note = document.getElementById('solveNote');
      if (solve && note){
        const ready = isAllPhase2Ready();
        solve.disabled = !ready;
        note.textContent = ready
          ? 'All objectives complete. Click to proceed.'
          : 'This will unlock once the four objectives above are completed.';
      }
    }

    // === Unlock condition: ONLY the four Phase 2 objectives ===
    function isAllPhase2Ready(){
      return progress.utDone && progress.wiringDone && progress.commsDone && progress.codedDone;
    }

    // ====== PHASE 2 FORMS ======
    function showUTForm(){
      if (progress.utDone) return;
      const host = document.getElementById('phase2-form-host');
      host.innerHTML = `
        <div class="inline-card">
          <h3>Universal Translator Code</h3>
          <div class="inline-row">
            <div><label>Word 1</label><input id="ut1" type="text" placeholder="word 1"></div>
            <div><label>Word 2</label><input id="ut2" type="text" placeholder="word 2"></div>
            <div><label>Word 3</label><input id="ut3" type="text" placeholder="word 3"></div>
          </div>
          <div class="muted" style="margin-top:6px">Enter the three keywords. Capitalization doesn’t matter.</div>
          <div class="feedback" id="utFeedback"></div>
          <div class="inline-actions">
            <button id="utCancel">Cancel</button>
            <button id="utSubmit">Submit</button>
          </div>
        </div>
      `;
      document.getElementById('utCancel').addEventListener('click', ()=> host.innerHTML = "");
      document.getElementById('utSubmit').addEventListener('click', submitUT);

      function submitUT(){
        const w1 = (document.getElementById('ut1').value||"").trim().toLowerCase();
        const w2 = (document.getElementById('ut2').value||"").trim().toLowerCase();
        const w3 = (document.getElementById('ut3').value||"").trim().toLowerCase();

        const exp1 = "trill", exp2 = "bolts", exp3 = "engineering";
        const fb = document.getElementById('utFeedback');

        if (w1 !== exp1 || w2 !== exp2 || w3 !== exp3){
          let errs = [];
          if (w1 !== exp1) errs.push("Word 1 is incorrect");
          if (w2 !== exp2) errs.push("Word 2 is incorrect");
          if (w3 !== exp3) errs.push("Word 3 is incorrect");
          fb.innerHTML = '<span class="err">' + errs.join("; ") + '.</span>';
          return;
        }

        progress.utDone = true; saveProgress();
        const btn = document.getElementById('btnUT'); if (btn){ btn.disabled = true; btn.textContent = "COMPLETED"; }
        host.innerHTML = "";
        updatePills();

        addTitledResponse("UNIVERSAL TRANSLATOR CODE", `With the message translated, you feed the keywords into the universal translator to get it working.
With that done you decide to ask Jora Tell about the allegation. After doing some looking around you find the ambassador…in your quarters. Bursting into the room, you are surprised to see Jora Tell holding the award that was bestowed upon you by Starfleet for busting an illegal tribble fighting ring.
“ Oh, I can explain… I was just… okay you caught me. Look, it’s not me—it’s the symbiont. Ever since Tell joined with me, it’s had these… urges. Some people inherit memories of great warriors or scientists. I inherited a kleptomaniac slug with sticky pseudopods. I don’t even want half the things I take!

 Last week it made me pocket a Bolian soap dish. Yesterday—three spoons from the mess hall. And now apparently it thinks this”—she shakes the award guiltily—“is irresistible.
I swear, if you check my quarters, you’ll find a collection of random junk that would embarrass even a Ferengi junk dealer. Please don’t hold it against me. I’m just along for the ride… and the shoplifting. I should be worried about the Tandaran fleet but here i am. I’m sorry, I will see myself out. good luck with your investigation.”

A quick look in her quarters confirms she has been taking things from the station, including a turbolift control node logged as missing between 1320 and 1455, when that system went offline, proving her presence elsewhere on the station.`);
      }
    }

    function showWiringForm(){
      if (progress.wiringDone) return;
      const host = document.getElementById('phase2-form-host');
      host.innerHTML = `
        <div class="inline-card">
          <h3>Wiring the Dabo Wheel</h3>
          <label for="wireCode">Enter sequence</label>
          <input id="wireCode" type="text" placeholder="Sequence">
          <div class="feedback" id="wireFb"></div>
          <div class="inline-actions">
            <button id="wireCancel">Cancel</button>
            <button id="wireSubmit">Submit</button>
          </div>
        </div>
      `;
      document.getElementById('wireCancel').addEventListener('click', ()=> host.innerHTML = "");
      document.getElementById('wireSubmit').addEventListener('click', submitWiring);
      document.getElementById('wireCode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitWiring(); });

      function submitWiring(){
        const val = (document.getElementById('wireCode').value||"").trim();
        const fb = document.getElementById('wireFb');
        if (val === "289514711612310"){
          progress.wiringDone = true; saveProgress();
          const btn = document.getElementById('btnWiring'); if (btn){ btn.disabled = true; btn.textContent = "COMPLETED"; }
          host.innerHTML = "";
          updatePills();

          addTitledResponse("WIRING THE DABO WHEEL", `Ahhh, music to my lobes! Profit restored, and the Dabo wheel sings once more. You’ve done excellent work — far better than my cousin, who still thinks a power coupling is something you order at a bar. Now, about our little… arrangement.

Nearly everyone on this station was at that blasted concert between 1300 and 1450. But not everyone. Your suspect, Lorr Vun? He wasn’t anywhere near the music hall. He was here, in my private gaming room — trying very hard to win back a rather embarrassing debt he owed me. And losing. Badly.

At first, I wasn’t going to mention it — the 33rd Rule of Acquisition says: It never hurts to suck up to the boss, and debts are leverage. But you’ve done me a favor, so I’ll do you one: I had them in my company the entire time the murder happened. The only thing they killed that night was their credit rating. If you could avoid mentioning to Vun I told you this, I would appreciate it. He has some tasty profits I would like to relieve him of still.

So, cross them off your list. They may be a poor gambler, but they’re no killer. Now… shall we talk about doubling the house cut on that wheel?`);
        } else {
          fb.innerHTML = '<span class="err">Incorrect sequence.</span>';
        }
      }
    }

    function showCommsForm(){
      if (progress.commsDone) return;
      const host = document.getElementById('phase2-form-host');
      host.innerHTML = `
        <div class="inline-card">
          <h3>Unauthorized Deep Space Communication</h3>
          <label for="commsCode">Enter access key</label>
          <input id="commsCode" type="text" placeholder="">
          <div class="muted" style="margin-top:6px">Capitalization and spacing do not matter.</div>
          <div class="feedback" id="commsFb"></div>
          <div class="inline-actions">
            <button id="commsCancel">Cancel</button>
            <button id="commsSubmit">Submit</button>
          </div>
        </div>
      `;
      document.getElementById('commsCancel').addEventListener('click', ()=> host.innerHTML = "");
      document.getElementById('commsSubmit').addEventListener('click', submitComms);
      document.getElementById('commsCode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitComms(); });

      function submitComms(){
        const raw = (document.getElementById('commsCode').value||"").toLowerCase().replace(/\s+/g,'');
        const fb = document.getElementById('commsFb');
        if (raw === "delta1701"){
          progress.commsDone = true; saveProgress();
          const btn = document.getElementById('btnComms'); if (btn){ btn.disabled = true; btn.textContent = "COMPLETED"; }
          host.innerHTML = "";
          updatePills();

          addTitledResponse("UNAUTHORIZED DEEP SPACE COMMUNICATION", `With the transmission locked in you enter the decryption key into the computer and are then able to easily decode the message that was sent:

“Dalra here...checking in on the package...was it received?...any word on it?...damn...any word? damn...i have to go...dalra out.”

Gil Dalra is in his quarters when you confront him about the package.

“What is it? Make it quick, I am trying to get off this damned station before it is blown apart.” he says before you interrupt him.

“Did you say ‘package’?!? How do you...you must have... okay, fine. I was using an unofficial method to send a message to a Cardassian vessel but sorry to spoil your grand thoughts of uncovering a conspiracy. The package in question was my audition tape for Cardassia’s Got Talent. I happen to be quite the accomplished singer and once those judges hear my audition I will be able to leave this miserable political career behind. Now if you will excuse me, I want to get off this station before my chance at stardom is crushed.`);
        } else {
          fb.innerHTML = '<span class="err">Access key rejected.</span>';
        }
      }
    }

    // NEW: coded message author form
    function showCodedForm(){
      if (progress.codedDone) return;
      const host = document.getElementById('phase2-form-host');
      host.innerHTML = `
        <div class="inline-card">
          <h3>Who wrote the coded message?</h3>
          <label for="codedAnswer">Enter name</label>
          <input id="codedAnswer" type="text" placeholder="">
          <div class="feedback" id="codedFb"></div>
          <div class="inline-actions">
            <button id="codedCancel">Cancel</button>
            <button id="codedSubmit">Submit</button>
          </div>
        </div>
      `;
      document.getElementById('codedCancel').addEventListener('click', ()=> host.innerHTML = "");
      document.getElementById('codedSubmit').addEventListener('click', submitCoded);
      document.getElementById('codedAnswer').addEventListener('keydown', e=>{ if(e.key==='Enter') submitCoded(); });

      function submitCoded(){
        const val = (document.getElementById('codedAnswer').value||"").trim().toLowerCase();
        const fb = document.getElementById('codedFb');
        if (val === "eno"){
          progress.codedDone = true; saveProgress();
          const btn = document.getElementById('btnCoded'); if (btn){ btn.disabled = true; btn.textContent = "COMPLETED"; }
          host.innerHTML = "";
          updatePills();

          addTitledResponse("CODED MESSAGE — AUTHOR CONFIRMED", 
`“So… you solved my little ‘cutout’ message? Hmph. I suppose I should be impressed. Yes, I made it myself. An old Denobulan espionage trick, a crude method for discretion. The message wasn’t about murder — it was about a private meeting. One that, frankly, would have caused far more trouble for me diplomatically than admitting this to you.”

“I met a certain ensign in Docking Ring C, Compartment 7, from 1313 until 1442. We were… discussing matters of a personal nature — and if you know anything about Denobulan relationships, you’ll understand why I wished to keep it private.”

“But here’s something you can check for yourself: I am the only Denobulan female on this station. The compartment’s environmental monitors automatically track species-specific respiration and pheromone levels for safety compliance. The records will show one Denobulan female and one Betazoid male, who was officially assigned to that docking compartment for the entire duration. Which means, Investigator… whoever committed your murder, it wasn’t me. I also trust you to not let this information pass to anyone else. 

“Now, if you’ll excuse me, I have station preparations to oversee before the Tandaran fleet arrives.”`);
        } else {
          fb.innerHTML = '<span class="err">That does not match the records.</span>';
        }
      }
    }

    function showSolveForm(){
      if (!isAllPhase2Ready()) return;
      const host = document.getElementById('phase2-form-host');
      host.innerHTML = `
        <div class="inline-card">
          <h3>Close the Case</h3>
          <div class="muted" style="margin-bottom:6px">Select all suspects you have eliminated from consideration.</div>
          <div id="suspectList" style="text-align:left">
            <label><input type="checkbox" value="Jora Tell"> Jora Tell</label><br/>
            <label><input type="checkbox" value="Nira Vess"> Nira Vess</label><br/>
            <label><input type="checkbox" value="Gil Dalra"> Gil Dalra</label><br/>
            <label><input type="checkbox" value="Lorr Vun"> Lorr Vun</label><br/>
            <label><input type="checkbox" value="Taldare Vok"> Taldare Vok</label><br/>
            <label><input type="checkbox" value="Eno Tavik"> Eno Tavik</label>
          </div>
          <div class="inline-actions">
            <button id="solveCancel">Cancel</button>
            <button id="solveSubmit">Submit</button>
          </div>
        </div>
      `;
      document.getElementById('solveCancel').addEventListener('click', ()=> host.innerHTML = "");
      document.getElementById('solveSubmit').addEventListener('click', ()=>{
        const boxes = [...document.querySelectorAll('#suspectList input[type=checkbox]')];
        const eliminated = boxes.filter(b=>b.checked).map(b=>b.value);
        host.innerHTML = "";

        // Correct eliminations = everyone EXCEPT Taldare Vok
        const allSuspects = ["Jora Tell","Nira Vess","Gil Dalra","Lorr Vun","Taldare Vok","Eno Tavik"];
        const correct = allSuspects.filter(s => s !== "Taldare Vok");

        if (eliminated.length === correct.length && correct.every(s => eliminated.includes(s))) {
          addTitledResponse("CASE CLOSURE — SUCCESS", 
            "You have correctly eliminated every suspect except Taldare Vok. Redirecting to case resolution...");
          setTimeout(()=> {
            window.location.href = "presolution.html";
          }, 3000);
        } else {
          addTitledResponse("CASE CLOSURE — REVIEW", 
            "Your eliminations do not match the evidence. Re-examine the clues and try again.");
        }
      });
    }

    // ====== Chat helpers ======
    function addResponse(text) {
      const div = document.createElement("div");
      div.classList.add("entry", "compas");
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      typeText(div, text, 10);
      if (voiceEnabled && text) { speakText(text); }
    }

    function addTitledResponse(title, body){
      const div = document.createElement("div");
      div.classList.add("entry","compas");
      div.innerHTML = `<b>${(title||"").toUpperCase()}</b>\n`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      typeText(div, body ? "\n"+body : "", 20);
      if (voiceEnabled && body) { speakText(title + ". " + body); }
    }

    function typeText(element, text, speed) {
      let i = 0;
      (function typing(){
        if (i < text.length) {
          element.append(document.createTextNode(text.charAt(i++)));
          chat.scrollTop = chat.scrollHeight;
          setTimeout(typing, speed);
        }
      })();
    }

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = speechSynthesis.getVoices().find(voice => voice.lang && voice.lang.includes('en')) || null;
      utterance.rate = 0.95;
      speechSynthesis.speak(utterance);
    }

    // ====== Time parsing helpers ======
    function parseTime(input){
      if(!input) return null;
      let s = input.trim().toUpperCase();

      const ampm = s.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      if(ampm){
        let h = parseInt(ampm[1],10);
        let m = ampm[2] ? parseInt(ampm[2],10) : 0;
        const tag = ampm[3].toUpperCase();
        if(h===12) h=0;
        if(tag==='PM') h+=12;
        if(h<0||h>23||m<0||m>59) return null;
        return String(h).padStart(2,'0') + String(m).padStart(2,'0');
      }
      const hm = s.match(/^(\d{1,2}):(\d{2})$/);
      if(hm){
        let h = parseInt(hm[1],10), m=parseInt(hm[2],10);
        if(h<0||h>23||m<0||m>59) return null;
        return String(h).padStart(2,'0') + String(m).padStart(2,'0');
      }
      const d = s.match(/^(\d{3,4})$/);
      if(d){
        let v = d[1].padStart(4,'0');
        let h = parseInt(v.slice(0,2),10), m = parseInt(v.slice(2),10);
        if(h<0||h>23||m<0||m>59) return null;
        return v;
      }
      return null;
    }
    function prettyHHMM(hhmm){
      if(!hhmm) return '';
      const h = parseInt(hhmm.slice(0,2),10), m = hhmm.slice(2);
      return `${String(h).padStart(2,'0')}:${m}`;
    }

    // ====== Phase 1 INLINE FORMS ======
    function showTimelineForm(){
      if (btnTimeline.disabled) return;
      formHost.innerHTML = `
        <div class="inline-card" id="tlCard">
          <h3>Submit Timeline</h3>
          <div class="inline-row">
            <div>
              <label for="tlStart">Start Time</label>
              <input id="tlStart" type="text" placeholder="e.g., 1500 or 3:00 PM" />
            </div>
            <div>
              <label for="tlEnd">End Time</label>
              <input id="tlEnd" type="text" placeholder="e.g., 1800 or 6:00 PM" />
            </div>
          </div>
          <div class="muted" style="margin-top:6px">You may also enter a range like <b>1200-1630</b> in the Start field and leave End blank.</div>
          <div class="feedback" id="tlFeedback"></div>
          <div class="inline-actions">
            <button id="tlCancel">Cancel</button>
            <button id="tlSubmit">Submit</button>
          </div>
        </div>
      `;
      const tlStart = document.getElementById('tlStart');
      const tlEnd = document.getElementById('tlEnd');
      const tlFeedback = document.getElementById('tlFeedback');
      document.getElementById('tlCancel').addEventListener('click', clearForm);
      document.getElementById('tlSubmit').addEventListener('click', submitTimelineInline);
      tlStart.focus();

      function submitTimelineInline(){
        const startVal = (tlStart.value||"").trim();
        const endVal = (tlEnd.value||"").trim();

        const range = startVal.replace(/\s+/g,'').match(/^(\d{3,4})-(\d{3,4})$/);
        let startParsed, endParsed;

        if(range && !endVal){
          startParsed = parseTime(range[1]);
          endParsed = parseTime(range[2]);
        } else {
          startParsed = parseTime(startVal);
          endParsed = parseTime(endVal);
        }

        if(!startParsed || !endParsed){
          tlFeedback.innerHTML = `<span class="err">Invalid format.</span> Use HHMM, HH:MM, or AM/PM (e.g., 1:00 PM).`;
          return;
        }

        const correctStart = (startParsed === "1300");
        const correctEnd   = (endParsed === "1440");

        if (correctStart && correctEnd){
          progress.timelineDone = true; saveProgress(); setButtonState(); clearForm();
          addResponse("Timeline accepted: " + prettyHHMM(startParsed) + "–" + prettyHHMM(endParsed) + ". Proceeding with correlation to access logs.");
          maybeAdvanceToPhase2();
        } else if (!correctStart && !correctEnd){
          tlFeedback.innerHTML = `<span class="err">Both the start and end times are incorrect.</span>`;
        } else if (!correctStart){
          tlFeedback.innerHTML = `<span class="warn">Start time is incorrect.</span>`;
        } else {
          tlFeedback.innerHTML = `<span class="warn">End time is incorrect.</span>`;
        }
      }

      tlStart.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitTimelineInline(); });
      tlEnd.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitTimelineInline(); });
    }

    function showCauseForm(){
      if (btnCause.disabled) return;
      formHost.innerHTML = `
        <div class="inline-card" id="cdCard">
          <h3>Submit Cause of Death</h3>
          <label for="cdText">Describe the cause</label>
          <input id="cdText" type="text" placeholder="e.g., Name of weapon" />
          <div class="muted" style="margin-top:6px"></div>
          <div class="feedback" id="cdFeedback"></div>
          <div class="inline-actions">
            <button id="cdCancel">Cancel</button>
            <button id="cdSubmit">Submit</button>
          </div>
        </div>
      `;
      const cdText = document.getElementById('cdText');
      const cdFeedback = document.getElementById('cdFeedback');
      document.getElementById('cdCancel').addEventListener('click', clearForm);
      document.getElementById('cdSubmit').addEventListener('click', submitCauseInline);
      cdText.focus();

      function isRacilineAnswer(msg){ return /\braciline\b/i.test(msg||""); }

      function submitCauseInline(){
        const val = cdText.value || "";
        if (isRacilineAnswer(val)){
          progress.causeDone = true; saveProgress(); setButtonState(); clearForm();
          addResponse("Confirmed. Cause of death recorded: Raciline poisoning.");
          maybeAdvanceToPhase2();
        } else {
          cdFeedback.innerHTML = `<span class="err">That doesn't match the forensic data.</span> Re-evaluate your answer.`;
        }
      }

      cdText.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitCauseInline(); });
    }

    // Button handlers (inline forms)
    btnTimeline.addEventListener('click', ()=>{
      if (btnTimeline.disabled) return;
      showTimelineForm();
    });
    btnCause.addEventListener('click', ()=>{
      if (btnCause.disabled) return;
      showCauseForm();
    });

    // ====== Original chat logic ======
    function handleInput() {
      const input = document.getElementById("user-input");
      const raw = input.value;
      const message = raw.trim().toLowerCase();
      if (!message) return;

      const playerDiv = document.createElement("div");
      playerDiv.classList.add("entry", "player");
      playerDiv.innerText = "> " + raw;
      chat.appendChild(playerDiv);
      chat.scrollTop = chat.scrollHeight;
      input.value = "";

      // HINT handling
      if (message === "more" || message === "hint more"){
        if (progress.lastHintTopic){
          deliverHint(progress.lastHintTopic);
        } else {
          addResponse("No active hint thread. Try “hint cause of death”, “wiring hint”, “hint timeline”, “hint comms”, or “hint coded message”.");
        }
        return;
      }
      if (/^hint\b/.test(message) || /\bhint\b/.test(message)){
        const topic = normalizeTopic(message);
        if (!topic){ addResponse(hintHelpText()); return; }
        deliverHint(topic);
        return;
      }

      // TIMELINE MODE (chat)
      if (timelineMode > 0) {
        const oneLine = (message.replace(/\s+/g,'').match(/^(\d{3,4})-(\d{3,4})$/));
        if (oneLine) {
          const s = parseTime(oneLine[1]);
          const e = parseTime(oneLine[2]);
          const startOk = (s === "1300");
          const endOk   = (e === "1440");
          if (startOk && endOk) {
            addResponse("Timeline accepted: 13:00–14:40. Proceeding with correlation to access logs.");
            timelineMode = 0; timelineStart = "";
            progress.timelineDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
          } else if (!startOk && !endOk) {
            addResponse("Neither the start nor end time matches the available data.");
          } else if (!startOk) {
            addResponse("The start time does not align with the available data.");
          } else {
            addResponse("The end time does not align with the available data.");
          }
          return;
        }

        if (timelineMode === 1) {
          const s = parseTime(message);
          if (s) {
            timelineStart = s;
            addResponse("Start time recorded. Please enter the end time (e.g., 1750).");
            timelineMode = 2;
          } else {
            addResponse("Please provide a valid time (e.g., 1750 or 5:50 PM) or enter both as 1200-1750.");
          }
          return;
        }
        if (timelineMode === 2) {
          const e = parseTime(message);
          if (e) {
            const startOk = (timelineStart === "1300");
            const endOk   = (e === "1440");
            if (startOk && endOk) {
              addResponse("Timeline accepted: 13:00–14:40. Proceeding with correlation to access logs.");
              timelineMode = 0; timelineStart = "";
              progress.timelineDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
            } else if (!startOk && !EndOk) {
              addResponse("Neither the start nor end time matches the available data.");
              timelineMode = 0; timelineStart = "";
            } else if (!startOk) {
              addResponse("The start time does not align with the available data.");
              timelineMode = 0; timelineStart = "";
            } else {
              addResponse("The end time does not align with the available data.");
              timelineMode = 0; timelineStart = "";
            }
          } else {
            addResponse("Please provide a valid time (e.g.,1230 or 12:30 PM) or enter both as 1200-1500.");
          }
          return;
        }
      }

      // CAUSE-OF-DEATH SUBMISSION MODE (chat)
      if (causeSubmitMode) {
        if (/\braciline\b/i.test(message)) {
          addResponse("Confirmed. Cause of death recorded: Raciline poisoning.");
          progress.causeDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
        } else {
          addResponse("Based on the available evidnce that does not seem right. Please check your notes, investigator.");
        }
        causeSubmitMode = false;
        return;
      }

      // Legacy multi-step kept for compatibility
      if (submissionStep === 1) {
        submittedCause = message;
        if (["poison","poisoning","food poisoning"].some(c => submittedCause.includes(c))) {
          addResponse("Cause accepted. Now enter the start time:");
          submissionStep = 2;
        } else {
          addResponse("That cause of death does not seem accurate. Please try again.");
        }
        return;
      }
      if (submissionStep === 2) {
        submittedStart = message;
        if (submittedStart === "1300") {
          addResponse("Start time accepted. Now enter the end time:");
          submissionStep = 3;
        } else {
          addResponse("That start time does not match the evidence. Please try again.");
        }
        return;
      }
      if (submissionStep === 3) {
        submittedEnd = message;
        if (submittedEnd === "1440") {
          addResponse("That seems correct. Let me analyze further... Accessing logs to determine who tampered with the victim's quarters and replicator during that window.");
          submissionStep = 0;
        } else {
          addResponse("That end time does not align with the data. Please try again.");
        }
        return;
      }

      // Legacy patch hint quick path
      if (message.includes("patch") || message.includes("paper") ||
          message.includes("letterhead") || message.includes("tandaran paper")) {
        addResponse(getPatchHint());
        return;
      }

      // New triggers
      if (message.includes("submit cause of death")) {
        addResponse(responses["submit cause of death"]);
        causeSubmitMode = true;
        return;
      }
      if (message.includes("submit timeline")) {
        addResponse(responses["submit timeline"]);
        timelineMode = 1;
        timelineStart = "";
        return;
      }

      // Existing trigger
      if (message.includes("submit forensic info")) {
        addResponse(responses["submit forensic info"]);
        submissionStep = 1;
        return;
      }

      // DIRECT RESPONSES
      if (responses[message]) { addResponse(responses[message]); return; }

      // SUSPECT LOOKUPS
      if (suspectKeywords[message]) { addResponse(suspectKeywords[message]); return; }

      // FLEXIBLE 'KILLER' QUESTIONS
      const killerPhrases = [
        "who is the killer","who do you think the killer is","do you know who the killer is","who killed him",
        "who killed her","who committed the murder","who committed the crime","who's the killer",
        "who was the murderer","is there a killer","who murdered","who is the murderer"
      ];
      for (const phrase of killerPhrases) {
        if (message.includes(phrase)) {
          addResponse("I am still analyzing the data, but I believe the answer lies within the inconsistencies in their statements and timelines. Examine the evidence. Trust your instincts, investigator.");
          return;
        }
      }

      addResponse("I do not have sufficient data to process that query.");
    }

    function getPatchHint() {
      const hint = patchHints[Math.min(patchHintStep, patchHints.length - 1)];
      patchHintStep++;
      return hint;
    }

    voiceToggle.addEventListener("click", function() {
      voiceEnabled = !voiceEnabled;
      voiceToggle.innerText = voiceEnabled ? "Voice: On" : "Voice: Off";
      if (!voiceEnabled) { speechSynthesis.cancel(); }
    });

    document.getElementById("user-input").addEventListener("keydown", function(e) {
      if (e.key === "Enter") { e.preventDefault(); handleInput(); }
    });

    window.addEventListener("load", function() {
      setButtonState();
      if (progress.timelineDone && progress.causeDone){
        if (progress.phase2GateAck){ renderPhase2(); }
        else { postPhase2GateMessage(); }
      } else {
        const introText = document.getElementById("intro-text").innerText;
        if (voiceEnabled) { speakText(introText); }
      }
    });
  </script>
</body>
</html>




