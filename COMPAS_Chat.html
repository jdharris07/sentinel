<!DOCTYPE html>
<html>
<head>
  <title>COMPAS Interface</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <link rel="stylesheet" type="text/css" href="classic.css">
  <style>
    #intro-text { white-space: pre-wrap; }
    #chat-box {
      padding: 20px;
      max-width: 600px;
      margin: 20px auto;
      background-color: #663300;
      border-radius: 20px;
      color: #FFCC66;
      box-shadow: 0 0 15px #FFCC66AA;
      height: 400px;
      overflow-y: auto;
    }
    .entry { margin-bottom: 15px; }
    .player { color: #88FF88; }
    .compas { color: #FFCC66; white-space: pre-wrap; }
    #input-area {
      display: flex; justify-content: center; margin-top: 10px; flex-wrap: wrap;
    }
    #user-input {
      flex: 1; min-width: 60%; padding: 8px; font-size: 16px;
      border-radius: 10px; border: 2px solid #FFCC66; background: #330000; color: #FFCC66; margin-bottom: 10px;
    }
    button {
      padding: 8px 20px; border-radius: 20px; background-color: #FFCC66; border: none;
      color: #330000; font-weight: bold; cursor: pointer; font-size: 16px; margin-left: 8px;
    }
    button:hover { background-color: #FFD97F; }
    #voice-toggle { margin-top: 10px; display: block; margin-left: auto; margin-right: auto; }

    /* Action buttons row */
    .actions-row{
      max-width: 600px; margin: 0 auto 8px auto; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
    }
    .task-btn{
      border-radius: 16px; padding: 10px 14px; border: 2px solid #FFCC66; background:#402000; color:#FFCC66;
      box-shadow: 0 0 8px #FFCC6644 inset;
    }
    .task-btn[disabled]{
      background:#153a25; border-color:#7cffb6; color:#b6ffd9; cursor: default;
    }

    /* Inline form host */
    #form-host{ max-width: 600px; margin: 0 auto 16px auto; }
    .inline-card{
      background:#402000; color:#FFCC66; border:2px solid #FFCC66; border-radius:16px; padding:12px;
      box-shadow:0 0 12px #FFCC6644 inset;
    }
    .inline-card h3{ margin: 0 0 10px 0; font-size: 18px; }
    .inline-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .inline-row > *{ flex:1 }
    .inline-card label{ display:block; font-size:13px; margin-bottom:4px; opacity:.9 }
    .inline-card input{
      width:100%; padding:10px; border-radius:10px; border:2px solid #FFCC66; background:#330000; color:#FFCC66;
    }
    .inline-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .muted{ opacity:.85; font-size: 13px; }
    .feedback{ margin-top:8px; font-size: 14px; }
    .ok{ color:#b6ffd9 }
    .warn{ color:#ffe28f }
    .err{ color:#ffd0d0 }

    /* Phase 2 simple layout */
    .phase2{
      max-width: 700px; margin: 30px auto; background:#331a00; border-radius: 20px; padding:20px;
      color:#FFCC66; box-shadow:0 0 15px #FFCC66AA;
      text-align:center;
    }
    .phase2 h2{ margin-top:0; }

  </style>
</head>
<body>
  <div class="wrap-everything">
    <section id="column-3">
      <div class="wrap">
        <div class="left-frame-top">
          <div class="panel-1 static-panel"></div>
          <div class="panel-2 static-panel">&nbsp;</div>
        </div>
        <div class="right-frame-top">
          <div class="banner"> LCARS • 58814.6 </div>
          <div class="bar-panel first-bar-panel">
            <div class="bar-1"></div><div class="bar-2"></div><div class="bar-3"></div><div class="bar-4"></div><div class="bar-5"></div>
          </div>
        </div>
      </div>
      <main id="main-root">
        <h1>COMPAS Assistance Console</h1>

        <!-- Action buttons -->
        <div class="actions-row" id="actions">
          <button id="btnTimeline" class="task-btn">Submit the timeline of the murder</button>
          <button id="btnCause" class="task-btn">Submit Cause of Death</button>
        </div>

        <!-- Inline form host -->
        <div id="form-host"></div>

        <div id="chat-box">
          <div class="entry compas" id="intro-text">Greetings. I am the Federation’s Central Operations Management and Protocol Assistance System — COMPAS. My primary functions aboard this station include coordinating critical systems, monitoring compliance with Starfleet protocols, and providing operational support to personnel… and occasionally reminding the Captain to hydrate.

I will assist you in your investigation to the best of my capacity, though based on available evidence and your apparent experience level, I calculate only a 14.7% probability that you will solve this case. Please do not take this personally — statistics are indifferent.

That said, low odds are still odds. Ask, and I will provide what information I can, but please note my responses may be limited as the station is preparing for the Tandaran fleet's arrival. It appears the logical next step is for you to determine the murder weapon as well as the timeline it could have occured.</div>
        </div>
        <div id="input-area">
          <input type="text" id="user-input" placeholder="Type your message here..." />
          <button onclick="handleInput()">Send</button>
        </div>
        <button id="voice-toggle">Voice: On</button>
      </main>
    </section>
  </div>

  <script>
    const chat = document.getElementById("chat-box");
    const voiceToggle = document.getElementById("voice-toggle");
    const mainRoot = document.getElementById("main-root");
    const btnTimeline = document.getElementById("btnTimeline");
    const btnCause = document.getElementById("btnCause");
    const formHost = document.getElementById("form-host");

    let voiceEnabled = true;

    // ====== Persistent state ======
    const LS_KEY = "compas_progress_v4";
    const stateDefault = { timelineDone:false, causeDone:false };
    let progress = loadProgress();

    function loadProgress(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? Object.assign({}, stateDefault, JSON.parse(raw)) : {...stateDefault};
      }catch(e){ return {...stateDefault}; }
    }
    function saveProgress(){
      localStorage.setItem(LS_KEY, JSON.stringify(progress));
    }

    // Keep chat state features from previous build
    let patchHintStep = 0;
    let submissionStep = 0;
    let submittedCause = "";
    let submittedStart = "";
    let submittedEnd = "";

    let causeSubmitMode = false;

    // Chat-only timeline stepper (still supported)
    let timelineMode = 0;
    let timelineStart = "";

    const validCauses = ["poison", "poisoning", "food poisoning"];

    const patchHints = [
      "The Tandaran insignia is not just decorative; it may serve as a key overlay to hidden information.",
      "Consider using the numbered points on the patch to guide your reading order.",
      "The patch points can align with specific marks or clues on the letterhead. Try moving it carefully to see where they match.",
      "There may be multiple ways to place the patch. Only one sequence will reveal a clear message when read in numerical order from 1 to 7.",
      "When correctly placed, the message will read clearly across the points in order. You are seeking something that resembles a passcode for Taldare."
    ];

    const responses = {
      "help": "I recommend beginning by interviewing each suspect carefully. Observe their statements for inconsistencies or hidden motives.\n\nAdditionally, look for secured data modules and encoded documents hidden throughout the station. These may contain vital clues when properly decoded.\n\nReturn to me anytime for further guidance.",
      "janeway": "Kathryn Janeway commanded the USS Voyager during its Delta Quadrant odyssey, later becoming a respected figure in Starfleet command and strategy circles.",
      "picard": "Jean-Luc Picard is a legendary Starfleet captain and diplomat, known for his critical role in numerous key negotiations and crises.",
      "kirk": "James T. Kirk was a pivotal Starfleet captain, renowned for his bold tactics and first-contact missions during the early days of Federation expansion.",
      "sisko": "Benjamin Sisko was the commanding officer of Deep Space Nine and played a major role during the Dominion War, shaping the balance of power in the quadrant.",
      "spock": "Spock served as science officer and later ambassador, bridging Vulcan logic and human intuition in countless missions and diplomatic efforts.",
      "enterprise": "The USS Enterprise has a long and storied history, representing the ideals of exploration and diplomacy. It remains one of Starfleet's most iconic starships.",
      "voyager": "The USS Voyager returned from its 70,000-light-year journey through the Delta Quadrant, greatly influencing current Federation diplomacy and technological advancement.",
      "station": "Starbase Sentinel is a highly advanced modular station, featuring diplomatic suites, tactical command centers, and research facilities. It serves as the focal point for Federation–Tandaran negotiations.",
      "starbase sentinel": "Starbase Sentinel is positioned just outside Tandaran space, serving as a diplomatic and tactical outpost on the edge of the Alpha Quadrant.",
      "submit forensic info": "Understood. Please enter the suspected cause of death first (e.g., poisoning or food poisoning).",
      "hello": "Hello, investiagtor. How may I help you?",
      "dragon con": "I have heard of this gathering that occurs annually on Earth. Rumor has it the best track there is the Trek track.",
      "submit cause of death": "Acknowledged. Please submit the cause of death.",
      "submit timeline": "Acknowledged. Please enter the start time (e.g., 1300). You may also enter both as 1300-1440."
    };

    const suspectKeywords = {
      "jora": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "tell": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "jora tell": "Ambassador Jora Tell is a Trill diplomat. Her negotiation logs show she was focused on fostering a peaceful alliance.",
      "nira": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "vess": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "nira vess": "Commander Nira Vess is an Andorian tactical advisor. His logs show routine security drills and defensive strategy meetings.",
      "dalra": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "gil": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "gil dalra": "Counselor Gil Dalra is a Cardassian psychological advisor. His session logs suggest involvement in crew morale assessments.",
      "lorr": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "vun": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "lorr vun": "Chief Specialist Lorr Vun is a Bolian engineer. Maintenance logs place him near plasma conduits during key intervals.",
      "renn": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "vok": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "renn vok": "Dr. Renn Vok is the Tandaran medical attaché. Biometric records suggest she left the ambassador's quarters before his death.",
      "eno": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review.",
      "tavik": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review.",
      "eno tavik": "Doctor Eno Tavik is a Denobulan medical consultant. Logs show unusual system accesses requiring further review."
    };

    // ====== UI helpers ======
    function setButtonState(){
      if (progress.timelineDone){
        btnTimeline.textContent = "COMPLETED";
        btnTimeline.disabled = true;
      } else {
        btnTimeline.textContent = "Submit the timeline of the murder";
        btnTimeline.disabled = false;
      }
      if (progress.causeDone){
        btnCause.textContent = "COMPLETED";
        btnCause.disabled = true;
      } else {
        btnCause.textContent = "Submit Cause of Death";
        btnCause.disabled = false;
      }
    }

    function clearForm(){ formHost.innerHTML = ""; }

    function maybeAdvanceToPhase2(){
      if (progress.timelineDone && progress.causeDone){
        mainRoot.innerHTML = `
          <h1>COMPAS — Phase 2</h1>
          <div class="phase2">
            <h2>Elimination Protocol</h2>
            <p class="muted">Preliminary objectives complete. Proceed to submit your elimination decision.</p>
            <button id="btnElimination" class="task-btn">Submit Elimination</button>
            <p class="muted" style="margin-top:14px">This is a placeholder action — wire it into your final logic when ready.</p>
          </div>
        `;
        const btnElim = document.getElementById('btnElimination');
        btnElim.addEventListener('click', ()=>{
          const who = prompt("Who would you like to eliminate (enter a name)?");
          if (!who) return;
          alert("Received. Logging elimination submission for: " + who + ". COMPAS will evaluate this in the final build.");
        });
      }
    }

    // ====== Time parsing helpers (accepts HHMM, HH:MM, and AM/PM) ======
    function parseTime(input){
      if(!input) return null;
      let s = input.trim().toUpperCase();

      // "HH:MM AM/PM" or "H:MM AM/PM" or "HH AM/PM"
      const ampm = s.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      if(ampm){
        let h = parseInt(ampm[1],10);
        let m = ampm[2] ? parseInt(ampm[2],10) : 0;
        const tag = ampm[3].toUpperCase();
        if(h===12) h=0;
        if(tag==='PM') h+=12;
        if(h<0||h>23||m<0||m>59) return null;
        return String(h).padStart(2,'0') + String(m).padStart(2,'0');
      }

      // "HH:MM" 24h
      const hm = s.match(/^(\d{1,2}):(\d{2})$/);
      if(hm){
        let h = parseInt(hm[1],10), m=parseInt(hm[2],10);
        if(h<0||h>23||m<0||m>59) return null;
        return String(h).padStart(2,'0') + String(m).padStart(2,'0');
      }

      // "HHMM"
      const d = s.match(/^(\d{3,4})$/);
      if(d){
        let v = d[1].padStart(4,'0');
        let h = parseInt(v.slice(0,2),10), m = parseInt(v.slice(2),10);
        if(h<0||h>23||m<0||m>59) return null;
        return v;
      }
      return null;
    }
    function prettyHHMM(hhmm){
      if(!hhmm) return '';
      const h = parseInt(hhmm.slice(0,2),10), m = hhmm.slice(2);
      return `${String(h).padStart(2,'0')}:${m}`;
    }

    // ====== Inline forms ======
    function showTimelineForm(){
      if (btnTimeline.disabled) return;
      formHost.innerHTML = `
        <div class="inline-card" id="tlCard">
          <h3>Submit Timeline</h3>
          <div class="inline-row">
            <div>
              <label for="tlStart">Start Time</label>
              <input id="tlStart" type="text" placeholder="e.g., 1500 or 3:00 PM" />
            </div>
            <div>
              <label for="tlEnd">End Time</label>
              <input id="tlEnd" type="text" placeholder="e.g., 1800 or 6:00 PM" />
            </div>
          </div>
          <div class="muted" style="margin-top:6px">You may also enter a range like <b>1200-1630</b> in the Start field and leave End blank.</div>
          <div class="feedback" id="tlFeedback"></div>
          <div class="inline-actions">
            <button id="tlCancel">Cancel</button>
            <button id="tlSubmit">Submit</button>
          </div>
        </div>
      `;
      const tlStart = document.getElementById('tlStart');
      const tlEnd = document.getElementById('tlEnd');
      const tlFeedback = document.getElementById('tlFeedback');
      document.getElementById('tlCancel').addEventListener('click', clearForm);
      document.getElementById('tlSubmit').addEventListener('click', submitTimelineInline);
      tlStart.focus();

      function submitTimelineInline(){
        const startVal = (tlStart.value||"").trim();
        const endVal = (tlEnd.value||"").trim();

        // Range allowed in start field
        const range = startVal.replace(/\s+/g,'').match(/^(\d{3,4})-(\d{3,4})$/);
        let startParsed, endParsed;

        if(range && !endVal){
          startParsed = parseTime(range[1]);
          endParsed = parseTime(range[2]);
        } else {
          startParsed = parseTime(startVal);
          endParsed = parseTime(endVal);
        }

        if(!startParsed || !endParsed){
          tlFeedback.innerHTML = `<span class="err">Invalid format.</span> Use HHMM, HH:MM, or AM/PM (e.g., 1:00 PM).`;
          return;
        }

        const correctStart = (startParsed === "1300");
        const correctEnd   = (endParsed === "1440");

        if (correctStart && correctEnd){
          progress.timelineDone = true; saveProgress(); setButtonState(); clearForm();
          addResponse("Timeline accepted: " + prettyHHMM(startParsed) + "–" + prettyHHMM(endParsed) + ". Proceeding with correlation to access logs.");
          maybeAdvanceToPhase2();
        } else if (!correctStart && !correctEnd){
          tlFeedback.innerHTML = `<span class="err">Both the start and end times are incorrect.</span>`;
        } else if (!correctStart){
          tlFeedback.innerHTML = `<span class="warn">Start time is incorrect.</span>`;
        } else {
          tlFeedback.innerHTML = `<span class="warn">End time is incorrect.</span>`;
        }
      }

      // Enter to submit from either input
      tlStart.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitTimelineInline(); });
      tlEnd.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitTimelineInline(); });
    }

    function showCauseForm(){
      if (btnCause.disabled) return;
      formHost.innerHTML = `
        <div class="inline-card" id="cdCard">
          <h3>Submit Cause of Death</h3>
          <label for="cdText">Describe the cause</label>
          <input id="cdText" type="text" placeholder="e.g., Name of weapon" />
          <div class="muted" style="margin-top:6px"></div>
          <div class="feedback" id="cdFeedback"></div>
          <div class="inline-actions">
            <button id="cdCancel">Cancel</button>
            <button id="cdSubmit">Submit</button>
          </div>
        </div>
      `;
      const cdText = document.getElementById('cdText');
      const cdFeedback = document.getElementById('cdFeedback');
      document.getElementById('cdCancel').addEventListener('click', clearForm);
      document.getElementById('cdSubmit').addEventListener('click', submitCauseInline);
      cdText.focus();

      function isRacilineAnswer(msg){ return /\braciline\b/i.test(msg||""); }

      function submitCauseInline(){
        const val = cdText.value || "";
        if (isRacilineAnswer(val)){
          progress.causeDone = true; saveProgress(); setButtonState(); clearForm();
          addResponse("Confirmed. Cause of death recorded: Raciline poisoning.");
          maybeAdvanceToPhase2();
        } else {
          cdFeedback.innerHTML = `<span class="err">That doesn't match the forensic data.</span> Re-evaluate your answer.`;
        }
      }

      cdText.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitCauseInline(); });
    }

    // Button handlers (inline forms)
    btnTimeline.addEventListener('click', ()=>{
      if (btnTimeline.disabled) return;
      showTimelineForm();
    });
    btnCause.addEventListener('click', ()=>{
      if (btnCause.disabled) return;
      showCauseForm();
    });

    // ====== Chat helpers ======
    function addResponse(text) {
      const div = document.createElement("div");
      div.classList.add("entry", "compas");
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      typeText(div, text, 20);
      if (voiceEnabled && text) { speakText(text); }
    }

    function typeText(element, text, speed) {
      let i = 0;
      (function typing(){
        if (i < text.length) {
          element.innerText += text.charAt(i++);
          chat.scrollTop = chat.scrollHeight;
          setTimeout(typing, speed);
        }
      })();
    }

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = speechSynthesis.getVoices().find(voice => voice.lang && voice.lang.includes('en')) || null;
      utterance.rate = 0.95;
      speechSynthesis.speak(utterance);
    }

    // ====== Original chat logic (kept; still supports type-based submissions) ======
    function handleInput() {
      const input = document.getElementById("user-input");
      const raw = input.value;
      const message = raw.trim().toLowerCase();
      if (!message) return;

      const playerDiv = document.createElement("div");
      playerDiv.classList.add("entry", "player");
      playerDiv.innerText = "> " + raw;
      chat.appendChild(playerDiv);
      chat.scrollTop = chat.scrollHeight;
      input.value = "";

      // TIMELINE MODE (chat)
      if (timelineMode > 0) {
        const oneLine = (message.replace(/\s+/g,'').match(/^(\d{3,4})-(\d{3,4})$/));
        if (oneLine) {
          const s = parseTime(oneLine[1]);
          const e = parseTime(oneLine[2]);
          const startOk = (s === "1300");
          const endOk   = (e === "1440");
          if (startOk && endOk) {
            addResponse("Timeline accepted: 13:00–14:40. Proceeding with correlation to access logs.");
            timelineMode = 0; timelineStart = "";
            progress.timelineDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
          } else if (!startOk && !endOk) {
            addResponse("Neither the start nor end time matches the available data.");
          } else if (!startOk) {
            addResponse("The start time does not align with the available data.");
          } else {
            addResponse("The end time does not align with the available data.");
          }
          return;
        }

        if (timelineMode === 1) {
          const s = parseTime(message);
          if (s) {
            timelineStart = s;
            addResponse("Start time recorded. Please enter the end time (e.g., 1750).");
            timelineMode = 2;
          } else {
            addResponse("Please provide a valid time (e.g., 1750 or 5:50 PM) or enter both as 1200-1750.");
          }
          return;
        }
        if (timelineMode === 2) {
          const e = parseTime(message);
          if (e) {
            const startOk = (timelineStart === "1300");
            const endOk   = (e === "1440");
            if (startOk && endOk) {
              addResponse("Timeline accepted: 13:00–14:40. Proceeding with correlation to access logs.");
              timelineMode = 0; timelineStart = "";
              progress.timelineDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
            } else if (!startOk && !endOk) {
              addResponse("Neither the start nor end time matches the available data.");
              timelineMode = 0; timelineStart = "";
            } else if (!startOk) {
              addResponse("The start time does not align with the available data.");
              timelineMode = 0; timelineStart = "";
            } else {
              addResponse("The end time does not align with the available data.");
              timelineMode = 0; timelineStart = "";
            }
          } else {
            addResponse("Please provide a valid time (e.g.,1230 or 12:30 PM) or enter both as 1200-1500.");
          }
          return;
        }
      }

      // CAUSE-OF-DEATH SUBMISSION MODE (chat)
      if (causeSubmitMode) {
        if (/\braciline\b/i.test(message)) {
          addResponse("Confirmed. Cause of death recorded: Raciline poisoning.");
          progress.causeDone = true; saveProgress(); setButtonState(); clearForm(); maybeAdvanceToPhase2();
        } else {
          addResponse("Based on the available evidnce that does not seem right. Please check your notes, investigator.");
        }
        causeSubmitMode = false;
        return;
      }

      // OLD multi-step (cause -> start -> end) kept for compatibility
      if (submissionStep === 1) {
        submittedCause = message;
        if (validCauses.some(c => submittedCause.includes(c))) {
          addResponse("Cause accepted. Now enter the start time:");
          submissionStep = 2;
        } else {
          addResponse("That cause of death does not seem accurate. Please try again.");
        }
        return;
      }
      if (submissionStep === 2) {
        submittedStart = message;
        if (submittedStart === "1300") {
          addResponse("Start time accepted. Now enter the end time:");
          submissionStep = 3;
        } else {
          addResponse("That start time does not match the evidence. Please try again.");
        }
        return;
      }
      if (submissionStep === 3) {
        submittedEnd = message;
        if (submittedEnd === "1440") {
          addResponse("That seems correct. Let me analyze further... Accessing logs to determine who tampered with the victim's quarters and replicator during that window.");
          submissionStep = 0;
        } else {
          addResponse("That end time does not align with the data. Please try again.");
        }
        return;
      }

      // PATCH HINTS
      if (message.includes("patch") || message.includes("hint") || message.includes("paper") ||
          message.includes("letterhead") || message.includes("tandaran paper")) {
        addResponse(getPatchHint());
        return;
      }

      // NEW TRIGGERS
      if (message.includes("submit cause of death")) {
        addResponse(responses["submit cause of death"]);
        causeSubmitMode = true;
        return;
      }
      if (message.includes("submit timeline")) {
        addResponse(responses["submit timeline"]);
        timelineMode = 1;
        timelineStart = "";
        return;
      }

      // EXISTING TRIGGER
      if (message.includes("submit forensic info")) {
        addResponse(responses["submit forensic info"]);
        submissionStep = 1;
        return;
      }

      // DIRECT RESPONSES
      if (responses[message]) { addResponse(responses[message]); return; }

      // SUSPECT LOOKUPS
      if (suspectKeywords[message]) { addResponse(suspectKeywords[message]); return; }

      // FLEXIBLE 'KILLER' QUESTIONS
      const killerPhrases = [
        "who is the killer","who do you think the killer is","do you know who the killer is","who killed him",
        "who killed her","who committed the murder","who committed the crime","who's the killer",
        "who was the murderer","is there a killer","who murdered","who is the murderer"
      ];
      for (const phrase of killerPhrases) {
        if (message.includes(phrase)) {
          addResponse("I am still analyzing the data, but I believe the answer lies within the inconsistencies in their statements and timelines. Trust your instincts, investigator.");
          return;
        }
      }

      addResponse("I do not have sufficient data to process that query.");
    }

    function getPatchHint() {
      const hint = patchHints[Math.min(patchHintStep, patchHints.length - 1)];
      patchHintStep++;
      return hint;
    }

    voiceToggle.addEventListener("click", function() {
      voiceEnabled = !voiceEnabled;
      voiceToggle.innerText = voiceEnabled ? "Voice: On" : "Voice: Off";
      if (!voiceEnabled) { speechSynthesis.cancel(); }
    });

    document.getElementById("user-input").addEventListener("keydown", function(e) {
      if (e.key === "Enter") { e.preventDefault(); handleInput(); }
    });

    window.addEventListener("load", function() {
      setButtonState();
      if (progress.timelineDone && progress.causeDone){
        maybeAdvanceToPhase2();
      } else {
        const introText = document.getElementById("intro-text").innerText;
        if (voiceEnabled) { speakText(introText); }
      }
    });
  </script>
</body>
</html>





