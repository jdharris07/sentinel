<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>K2 EMF — Hotspots</title>
<style>
  :root{
    --bg:#0a0f18; --ink:#e7f0ff; --muted:#aebedb; --grid:#23314a;
    --tile:#0e1524; --tile2:#121b2c;

    /* LED size (as % of image width). Adjust only if your PNG changes. */
    --led-size: 8.8%;

    /* === YOUR BAKED CALIBRATION (from localStorage) === */
    --l1x: 23.64%; --l1y: 11.36%;
    --l2x: 38.64%; --l2y: 10.68%;
    --l3x: 51.82%; --l3y: 10.34%;
    --l4x: 66.82%; --l4y: 10.68%;
    --l5x: 81.36%; --l5y: 11.36%;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,#060912,#0e1423);
    color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
  }

  header{
    position:sticky; top:0; z-index:10;
    padding: max(10px, env(safe-area-inset-top)) 16px 8px;
    background:rgba(10,15,25,.9);
    border-bottom:1px solid #1c2740;
  }
  h1{margin:0; font-size:16px; letter-spacing:.3px}

  .wrap{
    padding:10px max(10px, env(safe-area-inset-left)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-right));
  }

  /* Playfield */
  .field{
    position:relative; width:100%; max-width:600px; margin:0 auto;
    aspect-ratio: 9 / 16;
    background:linear-gradient(180deg,var(--tile),var(--tile2));
    border:1px solid var(--grid); border-radius:12px;
    box-shadow: inset 0 10px 28px rgba(0,0,0,.45);
    overflow:hidden; touch-action:none;
  }

  /* Hotspots (hidden visually; keep outline off in prod) */
  .hotspot{
    position:absolute;
    border:1px dashed transparent; border-radius:10px;
    background:transparent; color:transparent;
  }
  .hotspot.active{ outline:2px solid #7ee2b8; box-shadow:0 0 0 2px rgba(126,226,184,.25) }

  /* Draggable meter — only top+left (prevents stretch) */
  .meter{
    position:absolute; width: clamp(120px, 32vw, 220px);
    left: 3%; top: 65%;
    user-select:none; -webkit-user-drag:none; cursor:grab; touch-action:none; display:inline-block;
  }
  .meter.dragging{ cursor:grabbing }
  .meter img{display:block; width:100%; height:auto; pointer-events:none}

  /* LED overlay fills the image exactly */
  .leds{ position:absolute; inset:0; pointer-events:none; }
  .led{
    position:absolute; width:var(--led-size); aspect-ratio:1/1; border-radius:50%;
    opacity:.18; transform: translate(-50%, -50%);
    background: radial-gradient(circle at 50% 55%,
              rgba(255,255,255,.35) 0 28%,
              rgba(255,255,255,.05) 29% 55%,
              rgba(0,0,0,.15) 56% 100%);
  }
  /* Use baked CSS vars directly */
  .l1{ left: var(--l1x); top: var(--l1y); --col:#33d16a; } /* left green  */
  .l2{ left: var(--l2x); top: var(--l2y); --col:#27c15b; } /* right green */
  .l3{ left: var(--l3x); top: var(--l3y); --col:#f1d44e; } /* yellow      */
  .l4{ left: var(--l4x); top: var(--l4y); --col:#ff8a3d; } /* orange      */
  .l5{ left: var(--l5x); top: var(--l5y); --col:#ff4b4b; } /* red         */

  .led.on{
    opacity:1;
    box-shadow:0 0 6px var(--col), 0 0 18px color-mix(in srgb, var(--col) 55%, transparent);
    background: radial-gradient(circle at 50% 55%,
              #fff 0 18%,
              color-mix(in srgb, var(--col) 70%, #fff) 19% 52%,
              color-mix(in srgb, var(--col) 85%, #000) 53% 100%);
  }

  .status{ text-align:center; font-size:14px; color:var(--muted); margin-top:8px; min-height:22px }
</style>
</head>
<body>
<header><h1>K2 EMF Hotspots</h1></header>

<div class="wrap">
  <div id="field" class="field" aria-label="Playfield">
    <!-- Hotspots: data-x/y/w/h in %, data-level = 0–5 LEDs -->
    <div class="hotspot" data-x="5"  data-y="6"  data-w="22" data-h="14" data-level="2"></div>
    <div class="hotspot" data-x="31" data-y="18" data-w="22" data-h="14" data-level="3"></div>
    <div class="hotspot" data-x="57" data-y="7"  data-w="22" data-h="14" data-level="4"></div>
    <div class="hotspot" data-x="72" data-y="28" data-w="22" data-h="14" data-level="5"></div>
    <div class="hotspot" data-x="38" data-y="64" data-w="24" data-h="16" data-level="0"></div>

    <!-- K2 Meter -->
    <div id="meter" class="meter" aria-label="K2 Meter" role="img">
      <img id="k2img" src="K2meter.png" alt="K2 EMF meter" />
      <div class="leds">
        <span class="led l1"></span>
        <span class="led l2"></span>
        <span class="led l3"></span>
        <span class="led l4"></span>
        <span class="led l5"></span>
      </div>
    </div>
  </div>

  <div id="status" class="status" aria-live="polite"></div>
</div>

<script>
const field = document.getElementById('field');
const meter = document.getElementById('meter');
const statusEl = document.getElementById('status');
const leds = [...meter.querySelectorAll('.led')];
const hotspots = [...field.querySelectorAll('.hotspot')];

/* Layout hotspots responsively (percent-based) */
function layoutHotspots(){
  for(const h of hotspots){
    const x = +h.dataset.x, y = +h.dataset.y, w = +h.dataset.w, hgt = +h.dataset.h;
    h.style.left = x + '%'; h.style.top = y + '%';
    h.style.width = w + '%'; h.style.height = hgt + '%';
    h.style.position = 'absolute';
  }
}
window.addEventListener('resize', layoutHotspots);
layoutHotspots();

/* Dragging (top/left only) */
let dragging=false, start={x:0,y:0}, offset={x:meter.offsetLeft, y:meter.offsetTop};
function clamp(v,a,b){ return Math.min(b, Math.max(a,v)); }
function moveTo(x,y){
  const maxX = field.clientWidth - meter.clientWidth;
  const maxY = field.clientHeight - meter.clientHeight;
  offset.x = clamp(x,0,maxX); offset.y = clamp(y,0,maxY);
  meter.style.left = offset.x + 'px'; meter.style.top = offset.y + 'px';
  checkHotspots();
}
meter.addEventListener('pointerdown', (e)=>{ dragging=true; meter.setPointerCapture(e.pointerId); meter.classList.add('dragging'); start.x=e.clientX-offset.x; start.y=e.clientY-offset.y; });
meter.addEventListener('pointermove', (e)=>{ if(!dragging) return; moveTo(e.clientX-start.x, e.clientY-start.y); });
meter.addEventListener('pointerup',   (e)=>{ dragging=false; meter.classList.remove('dragging'); meter.releasePointerCapture?.(e.pointerId); });
meter.addEventListener('pointercancel',()=>{ dragging=false; meter.classList.remove('dragging'); });

/* Hotspot overlap → LED level */
function rect(el){ return el.getBoundingClientRect(); }
function overlapRatio(a,b){
  const x1=Math.max(a.left,b.left), y1=Math.max(a.top,b.top);
  const x2=Math.min(a.right,b.right), y2=Math.min(a.bottom,b.bottom);
  const w=Math.max(0,x2-x1), h=Math.max(0,y2-y1);
  return (b.width*b.height) ? (w*h)/(b.width*b.height) : 0;
}
function setLights(n){
  leds.forEach((el,i)=> el.classList.toggle('on', i<n));
  statusEl.textContent = n===1 ? `Level: ${n} light` : `Level: ${n} lights`;
}
function checkHotspots(){
  const m=rect(meter); let best=null, bestR=0;
  for(const h of hotspots){ const r=rect(h); const ratio=overlapRatio(m,r); if(ratio>bestR){bestR=ratio; best=h;} }
  const THRESH=0.25;
  hotspots.forEach(h=>h.classList.remove('active'));
  if(best && bestR>=THRESH){ best.classList.add('active'); setLights(parseInt(best.dataset.level||'0',10)); }
  else{ setLights(0); }
}

/* Init */
setLights(0);
checkHotspots();
</script>
</body>
</html>
