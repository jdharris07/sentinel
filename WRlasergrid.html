<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>What Remains</title>
<style>
  :root{
    --bg:#0b0f12; --panel:#111923; --ink:#eaf1ff; --edge:#1e2a37;
    --ok:#2fd46e; --err:#ff5e57;
    --tap:clamp(44px, 9.5vh, 64px);   /* min tap target */
    --gap:clamp(8px, 2vh, 14px);
    --rad:14px;
    --safe-b: max(env(safe-area-inset-bottom, 0px), 12px);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  /* Use small viewport unit so mobile chrome address bar doesn't clip */
  .wrap{min-height:100svh;display:flex;flex-direction:column;gap:var(--gap);padding:var(--gap);box-sizing:border-box}
  .bar{background:var(--panel);border:1px solid var(--edge);border-radius:var(--rad);padding:10px;
       text-align:center;font-weight:900;letter-spacing:.02em;font-size:clamp(14px,2.8vw,18px)}
  .stage{
    flex:1; min-height:0; background:#0d141c; border:1px solid var(--edge); border-radius:var(--rad);
    position:relative; overflow:hidden; /* the inner panels manage their own scrolling */
  }

  /* A) Wiring */
  .wire-ui{
    position:absolute; inset:0;
    display:grid; grid-template-columns:minmax(160px, 44vw) 1fr;
    gap:var(--gap); padding:var(--gap); box-sizing:border-box;
  }
  /* Make the left column independently scrollable so button 6 never clips */
  .left{
    display:flex; flex-direction:column; gap:var(--gap);
    overflow:auto; padding-bottom:calc(var(--safe-b) + 6px);
    -webkit-overflow-scrolling:touch;
  }
  .wireBtn{
    display:flex; align-items:center; gap:12px; height:var(--tap);
    padding:0 clamp(10px, 3.5vw, 16px);
    background:#14202c; border:1px solid #1e2a37; border-radius:12px;
    font-weight:900; font-size:clamp(14px,3.8vw,18px);
    cursor:pointer; user-select:none; touch-action:manipulation;
    transition:transform .06s ease, background .15s ease, opacity .15s ease;
  }
  .wireBtn:active{transform:scale(.98)}
  .wireBtn.disabled{opacity:.5;pointer-events:none;background:#0f1a24}
  .peg{width:clamp(16px,4.5vw,18px);height:clamp(16px,4.5vw,18px);border-radius:50%;
       background:#a0b9c9;border:2px solid rgba(255,255,255,.15)}
  .errorFlash{animation:flash .45s}
  @keyframes flash{ 0%{outline:2px solid var(--err)} 100%{outline:2px solid transparent} }

  .canvasArea{
    position:relative; border-radius:12px; background:#0b131b; border:1px solid #1b2732;
    overflow:hidden;
  }
  .bus{position:absolute; top:6%; bottom:6%; right:12px; width:6px; border-radius:6px; background:#2a323a}
  .cable{position:absolute; height:4px; background:#9cc1ff; border-radius:3px; transform-origin:left center}

  /* If the screen is very narrow, stack and let the left panel fill; hide bus art but keep gameplay */
  @media (max-width:640px){
    .wire-ui{grid-template-columns:1fr}
    .canvasArea{display:none}
  }

  /* B) Story (scrollable, with sticky button row) */
  .story{
    position:absolute; inset:0; display:none; flex-direction:column; gap:var(--gap);
    padding:var(--gap); box-sizing:border-box; overflow:auto;
  }
  .story.show{display:flex}
  .story p{margin:0; line-height:1.5; font-size:clamp(14px,3.6vw,18px)}
  .btnRow{
    position:sticky; bottom:0; left:0; right:0;
    padding:10px 0 calc(var(--safe-b)); margin-top:auto;
    background:linear-gradient(to top, rgba(13,20,28,0.96), rgba(13,20,28,0.5), rgba(13,20,28,0));
    display:flex; gap:10px;
  }
  .btn{
    appearance:none; border:0; background:#2c5cff; color:#fff; font-weight:900; border-radius:12px;
    padding:12px 16px; min-height:var(--tap); font-size:clamp(14px,3.8vw,18px); cursor:pointer; width:100%;
  }

  /* C) Laser grid */
  .grid{position:absolute; inset:0; display:none}
  .grid.show{display:block}
  .room{position:absolute; inset:0; background:#000 url("WRroom.png") center/cover no-repeat;
        filter:brightness(.75) contrast(1.05)}
  #laser{position:absolute; inset:0; width:100%; height:100%; display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    The only way to see if this thing will still work is going to be to wire it back up. With the manual long gone it will be trial and error to wire it back up in the correct sequence. I have to stop messing around with the exspensive equipment. 
  </div>

  <div class="stage" id="stage">

    <!-- A) Wiring -->
    <div class="wire-ui" id="wireUI">
      <div class="left" id="leftCol"></div>
      <div class="canvasArea" id="canvasArea">
        <div class="bus"></div>
      </div>
    </div>

    <!-- B) Story -->
    <div class="story" id="story">
      <p>
        With the final wire in place the laser grid turns on, meaning Mikey is off the hook for now. You decide to test it out by taking it into the room behind the pulpit. You are surprised to see Isaac siting in there looking at something in his hands. When he notices you, he jumps up, puts whatever he had inside his dirty jacket and begins to leave but stops and turns to you. Pulling something from his jacket you watch as he revals a dirty and worse for wear teddy bear. Without a word he sets it on the chair near you and leaves the room, shutting the door behind himself. Flipping the light off, you let your eyes adjust to the complete darkness, you turn on the laser grid and watch as neon green dots cover the wall opposite you. Just as you are about to turn it off, you see something moving in the light. You were alone in the room but something is moving around.
      </p>
      <div class="btnRow">
        <button class="btn" id="viewGridBtn">View Laser Grid</button>
      </div>
    </div>

    <!-- C) Laser Grid -->
    <div class="grid" id="grid">
      <div class="room"></div>
      <canvas id="laser"></canvas>
    </div>
  </div>

  <div class="bar" style="opacity:.6"></div>
</div>

<script>
/* ============== A) WIRING (left-only, resets on wrong) ============== */
(function(){
  const SECRET = [4,1,3,6,5,2]; // required order
  const leftCol   = document.getElementById('leftCol');
  const canvasBox = document.getElementById('canvasArea');
  const wireUI    = document.getElementById('wireUI');
  const story     = document.getElementById('story');

  let step = 0;

  function init(){
    leftCol.innerHTML = "";
    removeCables();
    step = 0;
    wireUI.style.display = "";
    story.classList.remove('show');

    for(let n=1;n<=6;n++){
      const btn = document.createElement('div');
      btn.className = 'wireBtn';
      btn.dataset.label = String(n);
      btn.innerHTML = `<div class="peg"></div><div>WIRE ${n}</div>`;
      btn.addEventListener('click', ()=>onTap(btn));
      btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); onTap(btn); }, {passive:false});
      leftCol.appendChild(btn);
    }
  }

  function onTap(btn){
    if (btn.classList.contains('disabled')) return;

    const label = Number(btn.dataset.label);
    const expected = SECRET[step];

    if (label !== expected){
      // WRONG → hard reset (as requested)
      flashError(btn);
      init();
      return;
    }

    // RIGHT → lock this wire and (if bus is visible) draw the cable
    btn.classList.add('disabled');
    if (canvasBox && canvasBox.offsetParent !== null) {
      drawCableToBus(btn);
    }

    step++;
    if (step >= SECRET.length){
      // success → proceed to story
      wireUI.style.display = 'none';
      story.classList.add('show');
    }
  }

  function flashError(btn){
    btn.classList.add('errorFlash');
    if (navigator.vibrate) { try{ navigator.vibrate(50); }catch(e){} }
    setTimeout(()=>btn.classList.remove('errorFlash'), 450);
  }

  function removeCables(){
    if (!canvasBox) return;
    canvasBox.querySelectorAll('.cable').forEach(el=>el.remove());
  }

  function drawCableToBus(btn){
    const peg = btn.querySelector('.peg');
    const stageRect = canvasBox.getBoundingClientRect();
    const pegRect = peg.getBoundingClientRect();
    const busRect = (canvasBox.querySelector('.bus')||canvasBox).getBoundingClientRect();

    const x1 = (pegRect.left + pegRect.right)/2 - stageRect.left;
    const y1 = (pegRect.top + pegRect.bottom)/2 - stageRect.top;

    const yMin = busRect.top - stageRect.top + 8;
    const yMax = busRect.bottom - stageRect.top - 8;
    const y2 = Math.max(yMin, Math.min(yMax, y1));
    const x2 = busRect.left - stageRect.left + busRect.width/2;

    const dx = x2 - x1, dy = y2 - y1;
    const len = Math.sqrt(dx*dx + dy*dy);
    const ang = Math.atan2(dy, dx) * 180 / Math.PI;

    const line = document.createElement('div');
    line.className = 'cable';
    line.style.left = x1 + 'px';
    line.style.top  = (y1 - 2) + 'px';
    line.style.width = '0px';
    line.style.transform = 'rotate(' + ang + 'deg)';
    canvasBox.appendChild(line);

    requestAnimationFrame(()=>{
      line.style.transition = 'width .30s ease';
      line.style.width = Math.max(0, len) + 'px';
    });
  }

  // Re-init on orientation change to keep layout robust
  window.addEventListener('orientationchange', ()=> setTimeout(init, 150), {passive:true});
  init();
})();

/* ============== B) LASER GRID (mobile-friendly loop) ============== */
(function(){
  const btn   = document.getElementById('viewGridBtn');
  const story = document.getElementById('story');
  const grid  = document.getElementById('grid');
  const canvas= document.getElementById('laser');
  const ctx   = canvas.getContext('2d');

  const PLAN = {
    meta:{rows:6, cols:23, dotRadiusPx:3},
    letters:{
      E:[6,8,10,12,14,16,18],
      D:[13,14,15,16,17,18,26,27,28,29,31,33,34,36,37,38,41,42],
      I:[43,44,45,46,47,48,55,56,57,58,59,60],
      T:[61,62,68,74,75,76,77,78,86,87,88,89,90,92,97,98],
      H:[103,104,105,106,107,108,115,116,118,119,120,121,122,124,125,126,133,134,135,136,137,138]
    }
  };
  const ORDER = ['E','D','I','T','H'];
  const sets  = {}; ORDER.forEach(k=>sets[k]=new Set(PLAN.letters[k]));

  let rows=PLAN.meta.rows, cols=PLAN.meta.cols;
  let W=0,H=0,spacing=24,origin={x:0,y:0},R=PLAN.meta.dotRadiusPx||3;
  let points=[];

  function fit(){
    const r = window.devicePixelRatio||1;
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width*r);
    canvas.height = Math.floor(rect.height*r);
    ctx.setTransform(r,0,0,r,0,0);
    W = rect.width; H = rect.height;

    const minDim = Math.min(W,H);
    const margin = minDim*0.08;
    spacing = Math.min( (W-2*margin)/(cols-1), (H-2*margin)/(rows-1) );
    origin.x = (W - (cols-1)*spacing)/2;
    origin.y = (H - (rows-1)*spacing)/2;

    R = Math.max(2.4, Math.min(4, PLAN.meta.dotRadiusPx||3));
    buildGrid();
    drawNeutral();
  }
  function buildGrid(){
    points.length=0;
    for(let c=0;c<cols;c++){
      for(let r=0;r<rows;r++){
        const x = origin.x + c*spacing;
        const y = origin.y + r*spacing;
        const id = c*rows + r + 1; // column-major indexing
        points.push({x,y,id});
      }
    }
  }
  function drawNeutral(){
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.shadowBlur=10; ctx.shadowColor='rgba(53,255,122,.5)';
    for(const p of points){
      ctx.beginPath(); ctx.arc(p.x,p.y,R,0,Math.PI*2);
      ctx.fillStyle='rgba(53,255,122,.95)'; ctx.fill();
    }
    ctx.restore();
  }
  function drawFrame(dim){
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.shadowBlur=10; ctx.shadowColor='rgba(53,255,122,.5)';
    for(const p of points){
      const k = dim(p); // 0..1 (1 = fully dim/off)
      const a = 0.95 * (1 - 0.96 * k);
      ctx.beginPath(); ctx.arc(p.x,p.y,R,0,Math.PI*2);
      if (a <= 0.06){ ctx.fillStyle='rgba(0,0,0,.98)'; ctx.shadowBlur=0; ctx.fill(); ctx.shadowBlur=10; }
      else { ctx.fillStyle='rgba(53,255,122,'+a+')'; ctx.fill(); }
    }
    ctx.restore();
  }
  const ease = (t)=> t<.5? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
  const dimSingle = (set,k)=>(p)=> set.has(p.id)?k:0;
  const dimCross  = (A,kA,B,kB)=>(p)=> Math.max(A.has(p.id)?kA:0, B.has(p.id)?kB:0);

  function animate(ms, render){
    return new Promise(res=>{
      const t0=performance.now();
      function tick(now){
        const t=Math.min(1,(now-t0)/ms);
        render(t);
        if(t<1) requestAnimationFrame(tick); else res();
      }
      requestAnimationFrame(tick);
    });
  }

  async function playOnce(){
    const chain = ORDER.filter(k=>PLAN.letters[k] && PLAN.letters[k].length);
    if (!chain.length){ drawNeutral(); return; }
    await animate(1200, t=>drawFrame(dimSingle(sets[chain[0]], ease(t))));
    await animate(600,  ()=>drawFrame(dimSingle(sets[chain[0]], 1)));
    for(let i=0;i<chain.length-1;i++){
      const A=sets[chain[i]], B=sets[chain[i+1]];
      await animate(1000, t=>drawFrame(dimCross(A,1-ease(t),B,ease(t))));
      await animate(500,  ()=>drawFrame(dimSingle(B,1)));
    }
    const last=sets[chain[chain.length-1]];
    await animate(1100, t=>drawFrame(dimSingle(last, 1-ease(t))));
    await animate(400,  ()=>drawNeutral());
  }

  function startLoop(){ (async function loop(){ while(true){ await playOnce(); } })(); }

  function showGrid(){
    story.classList.remove('show');
    grid.classList.add('show');
    fit();
    startLoop();
  }

  if (btn){
    btn.addEventListener('click', showGrid);
    btn.addEventListener('touchstart', e=>{ e.preventDefault(); showGrid(); }, {passive:false});
  }
  window.addEventListener('resize', fit, {passive:true});
  window.addEventListener('orientationchange', ()=> setTimeout(fit, 150), {passive:true});
})();
</script>
</body>
</html>



